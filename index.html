<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Operaciones AIFA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Roboto+Mono:wght@400;700&family=Roboto+Condensed:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="images/aifa-logo.png">
</head>

<body>

    <div id="login-screen" class="login-screen">
        <video id="login-bg-video" class="login-bg-video" autoplay muted loop playsinline poster="images/fondo-aifa.jpg">
            <source src="videos/Aterrizaje%20AIFA.mp4" type="video/mp4">
        </video>
        <div id="login-sky" aria-hidden="true"></div>
        <div class="login-overlay"></div>
        <div class="login-container">
            <div class="login-header">
                <img src="images/emblema-aviacion.png" alt="Emblema de la Aviación" class="login-logo" />
                <h1 id="login-title" class="h3">OPERACIONES-AIFA</h1>
                <p class="text-muted">Ingrese sus credenciales para continuar</p>
            </div>
            <form id="login-form" class="login-form">
                <div class="form-floating mb-3">
                    <input type="text" class="form-control" id="username" name="username" required placeholder=" " autocomplete="username">
                    <label for="username">Usuario</label>
                </div>
                <div class="form-floating mb-3">
                    <input type="password" class="form-control" id="password" name="password" required placeholder=" " autocomplete="current-password">
                    <label for="password">Contraseña</label>
                </div>
                <button type="submit" id="login-button" class="btn btn-primary w-100 py-2">
                    <span class="btn-text">Iniciar Sesión</span>
                    <span class="spinner-plane" aria-hidden="true"></span>
                </button>
                <div id="login-error" class="text-danger mt-2"></div>
            </form>
        </div>
    </div>

    <div id="main-app" class="main-app hidden">
        <header class="header p-3">
            <div id="flying-plane">
                <div class="contrail"></div>
            </div>
            <div class="container-fluid">
                <div class="header-content d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <button class="btn sidebar-toggler-btn" type="button" id="sidebar-toggler">
                            <i class="fas fa-bars"></i>
                        </button>
                        <img src="images/aifa-logo.png" alt="Logo AIFA" class="aifa-logo" />
                    </div>
                    <div class="text-center header-center-content">
                        <div class="d-flex align-items-center justify-content-center gap-3">
                            <img src="images/nlu-operacion.png" alt="Logo de Operación NLU" class="header-logo" />
                            <h1 class="main-title">AEROPUERTO INTERNACIONAL FELIPE ÁNGELES</h1>
                            <img src="images/emblema-aviacion.png" alt="Logo de Aviación" class="header-logo" />
                        </div>
                        <div id="current-user" class="current-user-display fw-bold mt-2"></div>
                    </div>
                    <div class="d-flex align-items-center gap-3 header-right-content">
                        <div class="clocks-wrapper d-flex gap-2 align-items-center">
                            <div class="formal-clock-container">
                                <div class="clock-label">HORA LOCAL</div>
                                <div class="formal-clock" id="formal-clock">00:00:00</div>
                            </div>
                            <div class="utc-clock-container">
                                <div class="clock-label">HORA UTC</div>
                                <div class="utc-clock" id="utc-clock">00:00:00</div>
                            </div>
                        </div>
                        
                        <img src="images/gobierno-mexico.png" alt="Logo del Gobierno de México" class="gob-logo" />
                        <!-- Tema fijo claro: se elimina el botón de cambio de tema -->
                        <a href="#" class="btn btn-outline-danger d-lg-none logout-button-mobile" data-action="logout" title="Cerrar Sesión">
                            <i class="fas fa-sign-out-alt"></i>
                        </a>
                    </div>
                </div>
            </div>
        </header>

            <p id="current-date" class="m-0 fw-bold text-center"></p>
        </div>

        <div class="app-body">
            <aside class="sidebar d-flex flex-column p-2" id="sidebar">
                <nav class="nav flex-column" id="sidebar-nav">
                    <a class="menu-item active" href="#" data-section="operaciones-totales"><i class="fas fa-home"></i><span>Inicio</span></a>
                    <a class="menu-item" href="#" data-section="parte-operaciones"><i class="fas fa-file-invoice"></i><span>Parte de Operaciones</span></a>
                    <a class="menu-item" href="#" data-section="inicio"><i class="fas fa-calendar-day"></i><span>Itinerario diario</span></a>
                    <a class="menu-item" href="#" data-section="itinerario"><i class="fas fa-chart-area"></i><span>Gráficas Itinerario</span></a>
                    <a class="menu-item" href="#" data-section="frecuencias-semana"><i class="fas fa-chart-bar"></i><span>Frecuencias semanales</span></a>
                    <a class="menu-item" href="#" data-section="puntualidad-agosto">
                        <span class="icon-clock-check" aria-hidden="true">
                            <i class="fas fa-clock"></i>
                            <i class="fas fa-check check" aria-hidden="true"></i>
                        </span>
                        <span>Puntualidad</span>
                    </a>
                    <a class="menu-item" href="#" data-section="demoras"><i class="fas fa-clock"></i><span>Demoras</span></a>
                    <a class="menu-item" id="itinerario-mensual-menu" href="#" data-section="itinerario-mensual"><i class="fas fa-table"></i><span>Itinerario Mensual</span></a>
                    <a class="menu-item" href="#" data-section="comparativa"><i class="fas fa-chart-line"></i><span>Comparativa</span></a>
                    <a class="menu-item" href="#" data-section="manifiestos"><i class="fas fa-file-signature"></i><span>Manifiestos</span></a>
                    <a class="menu-item" href="#" data-section="fauna"><i class="fas fa-dove"></i><span>Fauna</span></a>
                    
                    <a class="menu-item logout-item" href="#" data-action="logout"><i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span></a>
                </nav>
            </aside>
            <!-- Overlay para dispositivos móviles: permite cerrar el sidebar al tocar fuera -->
            <div id="sidebar-overlay" class="sidebar-overlay"></div>
            <main class="main-content flex-grow-1 p-3 p-md-4">
                <div id="file-protocol-warning" class="alert alert-warning alert-dismissible fade show d-none" role="alert">
                    <strong>Advertencia:</strong> Estás abriendo el archivo directamente (file://). Para evitar errores CORS al cargar CSV/JSON, inicia el servidor local y abre: <a href="http://localhost:3000" target="_blank" rel="noopener">http://localhost:3000</a>.
                    
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
                </div>

                <div id="inicio-section" class="content-section">
                    <div class="card">
                        <div class="card-header">
                            <ul class="nav nav-tabs card-header-tabs" id="inicioTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="interactivo-inicio-tab" data-bs-toggle="tab" data-bs-target="#interactivo-inicio-pane" type="button" role="tab" aria-controls="interactivo-inicio-pane" aria-selected="true"><i class="fas fa-table me-2"></i>Vista Interactiva</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="pdf-inicio-tab" data-bs-toggle="tab" data-bs-target="#pdf-inicio-pane" type="button" role="tab" aria-controls="pdf-inicio-pane" aria-selected="false"><i class="fas fa-file-pdf me-2"></i>Documento PDF Original</button>
                                </li>
                            </ul>
                        </div>
                        <div class="card-body">
                            <div class="tab-content" id="inicioTabContent">
                                <div class="tab-pane fade show active" id="interactivo-inicio-pane" role="tabpanel" aria-labelledby="interactivo-inicio-tab" tabindex="0">
                                    <div class="mb-3">
                                        <button class="btn btn-outline-primary w-100" data-bs-toggle="collapse" data-bs-target="#summary-collapse" aria-expanded="false" aria-controls="summary-collapse">
                                            Resumen de Operaciones
                                        </button>
                                        <span class="d-block small text-muted mt-2">Cifras preliminares del día.</span>
                                    </div>
                                    <div class="collapse" id="summary-collapse">
                                        <h4 class="mb-3"><i class="fas fa-list-ul me-2"></i>Resumen por Aerolínea</h4>
                                        <div id="summary-table-container" class="table-container-tech"></div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div id="filter-controls" class="filter-container mb-4">
                                                <div class="filter-header">
                                                    <i class="fas fa-filter me-2"></i>
                                                    <h5 class="mb-0">Filtros de Búsqueda</h5>
                                                </div>
                                                <div class="filters-bar">
                                                    <div class="chip">
                                                        <label><i class="fas fa-plane me-1"></i>Aerolínea</label>
                                                        <select id="airline-filter" class="form-select">
                                                            <option value="all" selected>Todas las Aerolíneas</option>
                                                        </select>
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-suitcase me-1"></i>Banda</label>
                                                        <input type="text" id="claim-filter" class="form-control" placeholder="Número/Nombre de banda...">
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-map-pin me-1"></i>Posición</label>
                                                        <select id="position-filter" class="form-select">
                                                            <option value="all" selected>Todas las posiciones</option>
                                                        </select>
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-plane-arrival me-1"></i>Origen</label>
                                                        <select id="origin-filter" class="form-select">
                                                            <option value="all" selected>Todos los orígenes</option>
                                                        </select>
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-plane-departure me-1"></i>Destino</label>
                                                        <select id="destination-filter" class="form-select">
                                                            <option value="all" selected>Todos los destinos</option>
                                                        </select>
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-search me-1"></i>Buscar</label>
                                                        <input type="text" id="global-search" class="form-control" placeholder="Aerolínea, origen, destino, vuelo...">
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-calendar-day me-1"></i>Fecha</label>
                                                        <input type="date" id="date-filter" class="form-control">
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-clock me-1"></i>Hora</label>
                                                        <select id="hour-filter" class="form-select">
                                                            <option value="all" selected>Todas</option>
                                                            <option value="00">00</option>
                                                            <option value="01">01</option>
                                                            <option value="02">02</option>
                                                            <option value="03">03</option>
                                                            <option value="04">04</option>
                                                            <option value="05">05</option>
                                                            <option value="06">06</option>
                                                            <option value="07">07</option>
                                                            <option value="08">08</option>
                                                            <option value="09">09</option>
                                                            <option value="10">10</option>
                                                            <option value="11">11</option>
                                                            <option value="12">12</option>
                                                            <option value="13">13</option>
                                                            <option value="14">14</option>
                                                            <option value="15">15</option>
                                                            <option value="16">16</option>
                                                            <option value="17">17</option>
                                                            <option value="18">18</option>
                                                            <option value="19">19</option>
                                                            <option value="20">20</option>
                                                            <option value="21">21</option>
                                                            <option value="22">22</option>
                                                            <option value="23">23</option>
                                                        </select>
                                                    </div>
                                                    <div class="chip">
                                                        <label><i class="fas fa-exchange-alt me-1"></i>Tipo de hora</label>
                                                        <select id="hour-type-filter" class="form-select">
                                                            <option value="both" selected>Ambas</option>
                                                            <option value="arr">Llegada</option>
                                                            <option value="dep">Salida</option>
                                                        </select>
                                                    </div>
                                                    <div class="filters-actions">
                                                        <button id="clear-filters" class="btn btn-outline-secondary btn-sm">Limpiar</button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex align-items-center justify-content-between mb-2">
                                                <h4 class="mb-0"><i class="fas fa-plane-departure me-2"></i>Itinerario de Pasajeros</h4>
                                                <div class="btn-group" role="group">
                                                    <button id="export-pax-full" class="btn btn-sm btn-outline-primary" title="Descargar CSV (toda la tabla)"><i class="fas fa-file-csv me-1"></i>CSV</button>
                                                </div>
                                            </div>
                                            <div class="itinerary-horizontal mb-4">
                                                <div class="d-flex justify-content-between align-items-center mb-2 h-scroll-controls">
                                                    <button class="btn btn-light border scroll-left" type="button" aria-label="Desplazar a la izquierda"><i class="fas fa-angle-left"></i></button>
                                                    <input type="range" class="form-range scroll-range" min="0" max="0" value="0" />
                                                    <button class="btn btn-light border scroll-right" type="button" aria-label="Desplazar a la derecha"><i class="fas fa-angle-right"></i></button>
                                                </div>
                                                <div id="passenger-itinerary-scroll" class="h-scroll-area">
                                                    <div id="passenger-itinerary-container" class="table-container-tech"></div>
                                                </div>
                                            </div>

                                            <div class="d-flex align-items-center justify-content-between mb-2 mt-4">
                                                <h4 class="mb-0"><i class="fas fa-truck-ramp-box me-2"></i>Itinerario de Carga</h4>
                                                <div class="btn-group" role="group">
                                                    <button id="export-cargo-full" class="btn btn-sm btn-outline-primary" title="Descargar CSV (toda la tabla)"><i class="fas fa-file-csv me-1"></i>CSV</button>
                                                </div>
                                            </div>
                                            <div class="itinerary-horizontal">
                                                <div class="d-flex justify-content-between align-items-center mb-2 h-scroll-controls">
                                                    <button class="btn btn-light border scroll-left" type="button" aria-label="Desplazar a la izquierda"><i class="fas fa-angle-left"></i></button>
                                                    <input type="range" class="form-range scroll-range" min="0" max="0" value="0" />
                                                    <button class="btn btn-light border scroll-right" type="button" aria-label="Desplazar a la derecha"><i class="fas fa-angle-right"></i></button>
                                                </div>
                                                <div id="cargo-itinerary-scroll" class="h-scroll-area">
                                                    <div id="cargo-itinerary-container" class="table-container-tech"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="pdf-inicio-pane" role="tabpanel" aria-labelledby="pdf-inicio-tab" tabindex="0">
                                    <div class="pdf-container">
                                        <iframe src="pdfs/Itinerario.pdf" width="100%" height="700px" class="border-0"></iframe>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="itinerario-section" class="content-section">
                    <div class="card">
                        <div class="card-header flex-column flex-md-row d-flex justify-content-between align-items-center">
                            <h2 class="mb-3 mb-md-0">ITINERARIO DETALLADO <small id="it-stats-badge" class="text-muted ms-2" style="font-size:0.8rem"></small></h2>
                            <div class="d-flex gap-2">
                                <a href="excel/itinerario_completo.xlsx" class="btn btn-success download-btn" download><i class="fas fa-file-excel me-2"></i><span class="btn-text">Descargar Excel</span></a>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Controles de fecha (vuelos del día) -->
                            <div class="d-flex flex-wrap align-items-center justify-content-end gap-2 mb-2" id="itinerary-day-controls">
                                <button class="btn btn-sm btn-outline-secondary" id="it-day-prev" title="Día anterior"><i class="fas fa-chevron-left"></i></button>
                                <input type="date" id="it-day-input" class="form-control form-control-sm" />
                                <button class="btn btn-sm btn-outline-secondary" id="it-day-next" title="Día siguiente"><i class="fas fa-chevron-right"></i></button>
                                <button class="btn btn-sm btn-outline-primary" id="it-day-today" title="Hoy"><i class="fas fa-calendar-day me-1"></i>Hoy</button>
                            </div>

                            <ul class="nav nav-tabs" id="itineraryTab" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#pasajeros-grafica-pane">1. Gráfica (Pasajeros)</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#carga-grafica-pane">2. Gráfica (Carga)</button></li>
                            </ul>
                            <div class="tab-content pt-3" id="itineraryTabContent">
                                <!-- Pasajeros: Llegadas/Salidas del día -->
                                <div class="tab-pane fade show active" id="pasajeros-grafica-pane">
                                    <div class="itinerary-charts-scroll">
                                        <div class="row g-3 chart-row-mobile-scroll">
                                        <div class="col-lg-6">
                                            <h6 class="text-muted mb-2"><i class="fas fa-person-walking me-1"></i>Llegadas (Pasajeros) por hora</h6>
                                            <div class="chart-container" style="height:360px"><canvas id="paxArrivalsChart"></canvas></div>
                                        </div>
                                        <div class="col-lg-6">
                                            <h6 class="text-muted mb-2"><i class="fas fa-person-walking-luggage me-1"></i>Salidas (Pasajeros) por hora</h6>
                                            <div class="chart-container" style="height:360px"><canvas id="paxDeparturesChart"></canvas></div>
                                        </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <i class="fas fa-star text-warning"></i>
                                            <strong>Top horas (Pasajeros)</strong>
                                            <span class="ms-auto small text-muted">Mostrar</span>
                                            <select id="pax-topN" class="form-select form-select-sm" style="width:auto;">
                                                <option value="3">Top 3</option>
                                                <option value="5" selected>Top 5</option>
                                                <option value="10">Top 10</option>
                                            </select>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="card"><div class="card-body">
                                                    <h6 class="text-muted">Llegadas</h6>
                                                    <ol id="pax-top-arr" class="m-0"></ol>
                                                </div></div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card"><div class="card-body">
                                                    <h6 class="text-muted">Salidas</h6>
                                                    <ol id="pax-top-dep" class="m-0"></ol>
                                                </div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Carga: Llegadas/Salidas del día -->
                                <div class="tab-pane fade" id="carga-grafica-pane">
                                    <div class="itinerary-charts-scroll">
                                        <div class="row g-3 chart-row-mobile-scroll">
                                        <div class="col-lg-6">
                                            <h6 class="text-muted mb-2"><i class="fas fa-box-open me-1"></i>Llegadas (Carga) por hora</h6>
                                            <div class="chart-container" style="height:360px"><canvas id="cargoArrivalsChart"></canvas></div>
                                        </div>
                                        <div class="col-lg-6">
                                            <h6 class="text-muted mb-2"><i class="fas fa-truck-ramp-box me-1"></i>Salidas (Carga) por hora</h6>
                                            <div class="chart-container" style="height:360px"><canvas id="cargoDeparturesChart"></canvas></div>
                                        </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <i class="fas fa-star text-warning"></i>
                                            <strong>Top horas (Carga)</strong>
                                            <span class="ms-auto small text-muted">Mostrar</span>
                                            <select id="cargo-topN" class="form-select form-select-sm" style="width:auto;">
                                                <option value="3">Top 3</option>
                                                <option value="5" selected>Top 5</option>
                                                <option value="10">Top 10</option>
                                            </select>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <div class="card"><div class="card-body">
                                                    <h6 class="text-muted">Llegadas</h6>
                                                    <ol id="cargo-top-arr" class="m-0"></ol>
                                                </div></div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="card"><div class="card-body">
                                                    <h6 class="text-muted">Salidas</h6>
                                                    <ol id="cargo-top-dep" class="m-0"></ol>
                                                </div></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </div>
                    </div>
                </div>

                <div id="parte-operaciones-section" class="content-section">
                    <div class="card">
                        <div class="card-header flex-column flex-md-row d-flex justify-content-between align-items-center">
                            <h2 class="mb-3 mb-md-0" id="operations-summary-title">Resumen de operaciones</h2>
                            <div class="d-flex gap-2">
                                <a href="pdfs/parte_operaciones_completo.pdf" class="btn btn-danger download-btn" download><i class="fas fa-file-pdf me-2"></i><span class="btn-text">Descargar PDF</span></a>
                                <a href="excel/parte_operaciones_completo.xlsx" class="btn btn-success download-btn" download><i class="fas fa-file-excel me-2"></i><span class="btn-text">Descargar Excel</span></a>
                            </div>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="operationsTab" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#resumen1-pane">Resumen 1</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#resumen2-pane">Resumen 2</button></li>
                            </ul>
                            <div class="tab-content pt-3" id="operationsTabContent">
                                <div class="tab-pane fade show active" id="resumen1-pane">
                                    <div id="operations-summary-table"></div>
                                </div>
                                <div class="tab-pane fade" id="resumen2-pane">
                                    <div class="pdf-container"><iframe src="pdfs/resumen_2.pdf" width="100%" height="700px" class="border-0"></iframe></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fauna Section -->
                <div id="fauna-section" class="content-section">
                    <div class="text-center mb-3"><h2 class="fw-bold"><i class="fas fa-dove me-2"></i>Registros de Impactos con Fauna 2025</h2></div>
                    <div class="card">
                        <div class="card-header d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-2">
                            <div class="d-flex flex-wrap align-items-center gap-2 fauna-filters filters-bar">
                                <div class="chip">
                                    <label class="me-1"><i class="fas fa-calendar-alt me-1"></i>Fecha</label>
                                    <input type="date" id="fauna-date-from" class="form-control form-control-sm" />
                                    <span class="mx-1">a</span>
                                    <input type="date" id="fauna-date-to" class="form-control form-control-sm" />
                                </div>
                                <div class="chip">
                                    <label class="me-1"><i class="fas fa-calendar me-1"></i>Mes</label>
                                    <select id="fauna-month" class="form-select form-select-sm">
                                        <option value="all" selected>Todos</option>
                                        <option value="01">Enero</option>
                                        <option value="02">Febrero</option>
                                        <option value="03">Marzo</option>
                                        <option value="04">Abril</option>
                                        <option value="05">Mayo</option>
                                        <option value="06">Junio</option>
                                        <option value="07">Julio</option>
                                        <option value="08">Agosto</option>
                                        <option value="09">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                                <div class="chip">
                                    <label class="me-1"><i class="fas fa-paw me-1"></i>Especie</label>
                                    <select id="fauna-species" class="form-select form-select-sm"><option value="all" selected>Todas</option></select>
                                </div>
                                <div class="chip">
                                    <label class="me-1"><i class="fas fa-arrows-to-dot me-1"></i>Tamaño</label>
                                    <select id="fauna-size" class="form-select form-select-sm"><option value="all" selected>Todos</option></select>
                                </div>
                                <div class="chip">
                                    <label class="me-1"><i class="fas fa-plane-departure me-1"></i>Fase</label>
                                    <select id="fauna-phase" class="form-select form-select-sm"><option value="all" selected>Todas</option></select>
                                </div>
                                    <div class="chip">
                                        <label class="me-1"><i class="fas fa-plane me-1"></i>Aerolínea</label>
                                        <select id="fauna-airline" class="form-select form-select-sm"><option value="all" selected>Todas</option></select>
                                    </div>
                                <div class="chip chip-actions">
                                    <label class="me-1"><i class="fas fa-broom me-1"></i>Acciones</label>
                                    <button id="fauna-clear" class="btn btn-outline-secondary btn-sm">Limpiar</button>
                                    <button id="fauna-export-csv" class="btn btn-outline-primary btn-sm"><i class="fas fa-file-csv me-1"></i>CSV</button>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
                                <span class="badge bg-primary" id="fauna-total-badge">Total: 0</span>
                                <span class="badge bg-info text-dark" id="fauna-period-badge">Periodo: Todos</span>
                                <button class="btn btn-outline-primary btn-sm active" id="fauna-summary-toggle" data-bs-toggle="collapse" data-bs-target="#fauna-summary-collapse" aria-expanded="true" aria-controls="fauna-summary-collapse">
                                    <i class="fas fa-list-ul me-1"></i>Resumen por Aerolínea
                                </button>
                            </div>
                            <div class="collapse show" id="fauna-summary-collapse">
                                <h6 class="mb-2"><i class="fas fa-plane me-2"></i>Resumen por Aerolínea</h6>
                                <div id="fauna-summary-container" class="table-container-tech"></div>
                            </div>
                            <!-- Top horas críticas arriba -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas fa-bolt text-warning"></i>
                                    <strong>Top horas críticas</strong>
                                    <span class="small text-muted">(con filtros aplicados)</span>
                                </div>
                                <div id="fauna-top-hours" class="mt-2 d-flex flex-wrap gap-2"></div>
                            </div>
                            <!-- Resumen despegues vs aterrizajes -->
                            <div class="mb-3">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="fas fa-plane me-1 text-primary"></i>
                                    <strong>Resumen por fase de operación</strong>
                                </div>
                                <div id="fauna-phase-summary" class="mt-2 d-flex flex-wrap gap-2"></div>
                            </div>
                            <!-- Resumen visual: gráficas -->
                            <div class="row g-3 mb-3">
                                <div class="col-lg-6">
                                    <h6 class="text-muted mb-2"><i class="fas fa-chart-column me-1"></i>Eventos por mes</h6>
                                    <div class="chart-container" style="height:360px"><canvas id="fauna-by-month"></canvas></div>
                                </div>
                                <div class="col-lg-6">
                                    <h6 class="text-muted mb-2"><i class="fas fa-paw me-1"></i>Eventos por especie</h6>
                                    <div class="chart-container" style="height:360px"><canvas id="fauna-by-species"></canvas></div>
                                </div>
                                <div class="col-12">
                                    <h6 class="text-muted mb-2"><i class="fas fa-grip-vertical me-1"></i>Matriz Mes × Condiciones (Heatmap)</h6>
                                    <div class="chart-container heatmap-container" style="height:420px"><div id="fauna-heatmap" style="width:100%; height:100%"></div></div>
                                </div>
                                <div class="col-12">
                                    <h6 class="text-muted mb-2"><i class="fas fa-clock me-1"></i>Distribución por hora del día</h6>
                                    <div class="chart-container" style="height:360px"><canvas id="fauna-by-hour"></canvas></div>
                                </div>
                            </div>
                            <!-- Tabla completa sin paginación -->
                            <div class="table-responsive" id="fauna-table-container"></div>
                        </div>
                    </div>
                </div>

                <div id="demoras-section" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h2 class="mb-0" id="demoras-title">Análisis de Demoras</h2>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <h3 class="h5 text-center mb-3">Demoras en vuelos de salida</h3>
                                <div class="table-responsive">
                                    <table class="table table-bordered text-center">
                                        <thead class="table-dark">
                                            <tr>
                                                <th>Causa</th>
                                                <th>Demoras</th>
                                                <th>Porcentaje</th>
                                            </tr>
                                        </thead>
                                        <tbody id="demoras-tbody"></tbody>
                                        <tfoot id="demoras-tfoot"></tfoot>
                                    </table>
                                </div>
                            </div>
                            <div class="chart-container" style="height: 380px;"><canvas id="delaysPieChart"></canvas></div>
                        </div>
                    </div>
                </div>

                <div id="operaciones-totales-section" class="content-section active">
                    <div class="card border-0">
                        <div class="card-header bg-transparent d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <div class="d-flex flex-column">
                                <h2 class="mb-2 mb-md-0">Operaciones Totales</h2>
                                <div class="update-note d-flex align-items-center"><i class="fas fa-calendar-check me-2"></i><small>Actualizado al <strong>30 octubre 2025</strong></small></div>
                            </div>
                            
                        </div>
                        <div class="card-body">
                            <!-- Toolbar compacta -->
                            <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#opsFiltersModal"><i class="fas fa-sliders-h me-1"></i>Configurar vista</button>
                                    <button class="btn btn-outline-primary btn-sm" id="ops-export-all-btn" title="Descargar todas las gráficas en PDF"><i class="fas fa-file-pdf me-1"></i>Descargar todas</button>
                                </div>
                                <div id="ops-summary" class="ops-summary-slot"></div>
                            </div>

                            <!-- Modal de Filtros de Operaciones Totales -->
                            <div class="modal fade" id="opsFiltersModal" tabindex="-1" aria-labelledby="opsFiltersModalLabel" aria-hidden="true">
                              <div class="modal-dialog modal-lg modal-dialog-scrollable">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title" id="opsFiltersModalLabel"><i class="fas fa-sliders-h me-2"></i>Configurar visualización</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                  </div>
                                  <div class="modal-body">
                                    <div class="mb-3">
                                        <h6 class="text-muted">Visual</h6>
                                        <div class="d-flex flex-wrap align-items-center gap-3">
                                            <div class="form-check form-switch m-0" title="Comparativo semanal reciente">
                                                <input class="form-check-input" type="checkbox" id="toggle-weekly-view">
                                                <label class="form-check-label small" for="toggle-weekly-view">Semanal</label>
                                            </div>
                                            <div class="form-check form-switch m-0" title="Activa los filtros por meses del año 2025">
                                                <input class="form-check-input" type="checkbox" id="toggle-monthly-2025">
                                                <label class="form-check-label small" for="toggle-monthly-2025">Mensual 2025</label>
                                                <span class="badge bg-info text-dark ms-2 d-none" id="years-disabled-hint">Años inactivos</span>
                                            </div>
                                            <div class="form-check form-switch m-0" title="Vista acumulada por año">
                                                <input class="form-check-input" type="checkbox" id="toggle-yearly-view">
                                                <label class="form-check-label small" for="toggle-yearly-view">Anual</label>
                                            </div>
                                            <div id="weekly-day-filter" class="d-none d-flex align-items-center gap-2">
                                                <label for="weekly-day-select" class="small text-muted fw-semibold mb-0">Día</label>
                                                <select id="weekly-day-select" class="form-select form-select-sm"></select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <h6 class="text-muted">Vistas rápidas</h6>
                                        <div class="d-flex flex-wrap align-items-center gap-2">
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="preset-ops"><i class="fas fa-tachometer-alt me-1"></i>Operaciones</button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="preset-full"><i class="fas fa-layer-group me-1"></i>Completa</button>
                                        </div>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-12 col-lg-6">
                                            <h6 class="text-muted">Secciones</h6>
                                            <div class="d-flex flex-wrap gap-3" id="ops-sections-filters">
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-section-comercial" checked>
                                                    <label class="form-check-label" for="filter-section-comercial">Comercial</label>
                                                </div>
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-section-carga" checked>
                                                    <label class="form-check-label" for="filter-section-carga">Carga</label>
                                                </div>
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-section-general" checked>
                                                    <label class="form-check-label" for="filter-section-general">General</label>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <h6 class="text-muted">Años <small class="text-muted">(se desactivan en modo mensual)</small></h6>
                                            <div class="d-flex flex-wrap gap-3" id="ops-years-filters">
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-year-2022" data-year="2022" checked>
                                                    <label class="form-check-label" for="filter-year-2022">2022</label>
                                                </div>
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-year-2023" data-year="2023" checked>
                                                    <label class="form-check-label" for="filter-year-2023">2023</label>
                                                </div>
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-year-2024" data-year="2024" checked>
                                                    <label class="form-check-label" for="filter-year-2024">2024</label>
                                                </div>
                                                <div class="form-check m-0">
                                                    <input class="form-check-input" type="checkbox" id="filter-year-2025" data-year="2025" checked>
                                                    <label class="form-check-label" for="filter-year-2025">2025</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4" id="ops-months-2025" style="display:none;">
                                        <h6 class="text-muted">Meses 2025</h6>
                                        <p class="small text-muted mb-2">Selecciona los meses que deseas visualizar; las gráficas solo mostrarán datos de los meses marcados.</p>
                                        <div class="d-flex flex-wrap align-items-center gap-2">
                                            <div class="months-chips d-flex flex-wrap gap-1">
                                                <label class="chip"><input type="checkbox" data-month="01" checked><span class="chip-text">Ene</span></label>
                                                <label class="chip"><input type="checkbox" data-month="02" checked><span class="chip-text">Feb</span></label>
                                                <label class="chip"><input type="checkbox" data-month="03" checked><span class="chip-text">Mar</span></label>
                                                <label class="chip"><input type="checkbox" data-month="04" checked><span class="chip-text">Abr</span></label>
                                                <label class="chip"><input type="checkbox" data-month="05" checked><span class="chip-text">May</span></label>
                                                <label class="chip"><input type="checkbox" data-month="06" checked><span class="chip-text">Jun</span></label>
                                                <label class="chip"><input type="checkbox" data-month="07" checked><span class="chip-text">Jul</span></label>
                                                <label class="chip"><input type="checkbox" data-month="08" checked><span class="chip-text">Ago</span></label>
                                                <label class="chip"><input type="checkbox" data-month="09" checked><span class="chip-text">Sep</span></label>
                                                <label class="chip"><input type="checkbox" data-month="10" checked><span class="chip-text">Oct</span></label>
                                                <label class="chip"><input type="checkbox" data-month="11" checked><span class="chip-text">Nov</span></label>
                                                <label class="chip"><input type="checkbox" data-month="12" checked><span class="chip-text">Dic</span></label>
                                            </div>
                                            <div class="ms-auto d-flex gap-2">
                                                <button class="btn btn-sm btn-outline-secondary" id="months-select-all">Todos</button>
                                                <button class="btn btn-sm btn-outline-secondary" id="months-select-none">Ninguno</button>
                                            </div>
                                        </div>
                                    </div>
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Aplicar</button>
                                  </div>
                                </div>
                              </div>
                            </div>
                            
                            <h5 class="text-uppercase text-muted fw-bold mb-3"><span class="section-icon icon-commercial">✈</span>Aviación Comercial</h5>
                            <div class="row g-3 mb-4" id="commercial-group">
                                <div class="col-lg-6">
                                    <div class="chart-container ops-chart"><canvas id="commercialOpsChart"></canvas></div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="chart-container ops-chart"><canvas id="commercialPaxChart"></canvas></div>
                                </div>
                            </div>
                            <h5 class="text-uppercase text-muted fw-bold mb-3 mt-4"><span class="section-icon icon-cargo">⛟</span>Operaciones de Carga</h5>
                            <div class="update-note d-flex align-items-center mb-2">
                                <i class="fas fa-calendar-check me-2" aria-hidden="true"></i>
                                <small>Datos actualizados al <strong>31 de octubre 2025</strong></small>
                            </div>
                            <div class="row g-3 mb-4" id="cargo-group">
                                <div class="col-lg-6">
                                    <div class="chart-container ops-chart"><canvas id="cargoOpsChart"></canvas></div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="chart-container ops-chart"><canvas id="cargoTonsChart"></canvas></div>
                                </div>
                            </div>
                            <h5 class="text-uppercase text-muted fw-bold mb-3 mt-4"><span class="section-icon icon-general">🛩</span>Aviación General</h5>
                            <div class="row g-3 mb-4" id="general-group">
                                <div class="col-lg-6">
                                    <div class="chart-container ops-chart"><canvas id="generalOpsChart"></canvas></div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="chart-container ops-chart"><canvas id="generalPaxChart"></canvas></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Frecuencias de la semana (tabbed PDFs) -->
                <div id="frecuencias-semana-section" class="content-section">
                    <div class="card border-0">
                        <div class="card-header bg-transparent d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                            <h2 class="mb-2 mb-md-0">Frecuencias semanales</h2>
                            <div class="small text-muted">Documentos oficiales (PDF)</div>
                        </div>
                        <div class="card-body pdf-container">
                            <ul class="nav nav-tabs" id="frecuenciasTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="frecuencias-nac-tab" data-bs-toggle="tab" data-bs-target="#frecuencias-nac-pane" type="button" role="tab" aria-controls="frecuencias-nac-pane" aria-selected="true">Frecuencias semanales Nacionales</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="frecuencias-int-tab" data-bs-toggle="tab" data-bs-target="#frecuencias-int-pane" type="button" role="tab" aria-controls="frecuencias-int-pane" aria-selected="false">Frecuencias semanales Internacionales</button>
                                </li>
                            </ul>
                            <div class="tab-content pt-3" id="frecuenciasTabContent">
                                <div class="tab-pane fade show active" id="frecuencias-nac-pane" role="tabpanel" aria-labelledby="frecuencias-nac-tab" tabindex="0">
                                    <div id="frecuencias-viewer-nac" class="pdf-singlepage-viewer" data-src="pdfs/frecuencias_semanales.pdf" style="position:relative; width:100%; max-width:100%;">
                                        <canvas style="width:100%; height:auto; display:block;"></canvas>
                                        <div class="links-layer" style="position:absolute; left:0; top:0; pointer-events:none;"></div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="frecuencias-int-pane" role="tabpanel" aria-labelledby="frecuencias-int-tab" tabindex="0">
                                    <div id="frecuencias-viewer-int" class="pdf-singlepage-viewer" data-src="pdfs/frecuencias_semanales_internacionales.pdf" style="position:relative; width:100%; max-width:100%;">
                                        <canvas style="width:100%; height:auto; display:block;"></canvas>
                                        <div class="links-layer" style="position:absolute; left:0; top:0; pointer-events:none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="itinerario-mensual-section" class="content-section">
                    <div class="card">
                        <div class="card-header text-center">
                            <h2 class="mb-0">ITINERARIO MENSUAL DEL MES DE NOVIEMBRE </h2>
                        </div>
                        <div class="card-body pdf-container">
                            <iframe id="pdf-itinerario-mensual" src="pdfs/itinerario_mensual.pdf" width="100%" height="800px" class="border-0"></iframe>
                            <button class="btn btn-outline-primary w-100 mt-2" data-fullscreen-target="#pdf-itinerario-mensual"><i class="fas fa-expand me-2"></i>Ver en Pantalla Completa</button>
                        </div>
                    </div>
                </div>
                <div id="puntualidad-agosto-section" class="content-section">
                    <div class="card">
                        <div class="card-header d-flex align-items-center justify-content-center">
                            <i class="fas fa-clock-check fa-2x text-primary me-3"></i>
                            <h2 class="mb-0">PUNTUALIDAD DE AEROLÍNEAS DEL MES DE SEPTIEMBRE</h2>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-tabs" id="puntualidadTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="punc-interactivo-tab" data-bs-toggle="tab" data-bs-target="#punc-interactivo-pane" type="button" role="tab" aria-controls="punc-interactivo-pane" aria-selected="true"><i class="fas fa-table me-2"></i>Vista Interactiva</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="punc-pdf-tab" data-bs-toggle="tab" data-bs-target="#punc-pdf-pane" type="button" role="tab" aria-controls="punc-pdf-pane" aria-selected="false"><i class="fas fa-file-pdf me-2"></i>Documento PDF Original</button>
                                </li>
                            </ul>
                            <div class="tab-content pt-3" id="puntualidadTabContent">
                                <div class="tab-pane fade show active" id="punc-interactivo-pane" role="tabpanel" aria-labelledby="punc-interactivo-tab" tabindex="0">
                                    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="small text-muted">Umbral puntualidad:</span>
                                            <span class="badge bg-success">≥ 85% Puntual</span>
                                            <span class="badge bg-danger">&lt; 85% Impuntual</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <label for="puntualidad-minflights" class="small text-muted m-0">Mín. vuelos
                                                <i id="minflights-help" class="fas fa-circle-question ms-1 text-muted" data-bs-toggle="tooltip" data-bs-placement="top" title="Sólo afecta los TOPs: excluye aerolíneas con menos vuelos que este mínimo."></i>
                                            </label>
                                            <select id="puntualidad-minflights" class="form-select form-select-sm" style="width:auto;">
                                                <option value="1">1</option>
                                                <option value="3">3</option>
                                                <option value="5" selected>5</option>
                                                <option value="10">10</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3 mb-3">
                                        <div class="col-12 col-lg-6">
                                            <div class="card h-100 punc-card punc-passengers">
                                                <div class="card-header d-flex align-items-center gap-2"><i class="fas fa-user-friends text-primary"></i><strong>Pasajeros</strong></div>
                                                <div class="card-body">
                                                    <div class="row g-3">
                                                        <div class="col-12 col-md-6 punc-best-col">
                                                            <h6 class="text-success mb-2 punc-col-title punc-col-best"><i class="fas fa-trophy me-1"></i>Más puntuales</h6>
                                                            <ol id="puntualidad-top-pax-best" class="m-0"></ol>
                                                            <div class="mt-2"><canvas id="punc-pax-best-chart" height="140"></canvas></div>
                                                        </div>
                                                        <div class="col-12 col-md-6 punc-worst-col">
                                                            <h6 class="text-danger mb-2 punc-col-title punc-col-worst"><i class="fas fa-triangle-exclamation me-1"></i>Más impuntuales</h6>
                                                            <ol id="puntualidad-top-pax-worst" class="m-0"></ol>
                                                            <div class="mt-2"><canvas id="punc-pax-worst-chart" height="140"></canvas></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-lg-6">
                                            <div class="card h-100 punc-card punc-cargo">
                                                <div class="card-header d-flex align-items-center gap-2"><i class="fas fa-box-open text-warning"></i><strong>Carga</strong></div>
                                                <div class="card-body">
                                                    <div class="row g-3">
                                                        <div class="col-12 col-md-6 punc-best-col">
                                                            <h6 class="text-success mb-2 punc-col-title punc-col-best"><i class="fas fa-trophy me-1"></i>Más puntuales</h6>
                                                            <ol id="puntualidad-top-cargo-best" class="m-0"></ol>
                                                            <div class="mt-2"><canvas id="punc-cargo-best-chart" height="140"></canvas></div>
                                                        </div>
                                                        <div class="col-12 col-md-6 punc-worst-col">
                                                            <h6 class="text-danger mb-2 punc-col-title punc-col-worst"><i class="fas fa-triangle-exclamation me-1"></i>Más impuntuales</h6>
                                                            <ol id="puntualidad-top-cargo-worst" class="m-0"></ol>
                                                            <div class="mt-2"><canvas id="punc-cargo-worst-chart" height="140"></canvas></div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive" id="puntualidad-table-container"></div>
                                </div>
                                <div class="tab-pane fade" id="punc-pdf-pane" role="tabpanel" aria-labelledby="punc-pdf-tab" tabindex="0">
                                    <div class="pdf-container">
                                        <div class="pdf-singlepage-viewer v-scroll" data-src="pdfs/puntualidad_agosto.pdf" style="position:relative; width:100%; max-width:100%;">
                                            <canvas style="width:100%; height:auto; display:block;"></canvas>
                                            <div class="links-layer" style="position:absolute; left:0; top:0; pointer-events:none;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="comparativa-section" class="content-section">
                    <div class="card border-0">
                        <div class="card-header bg-transparent">
                            <h2 class="mb-0">Análisis Comparativo</h2>
                        </div>
                        <div class="card-body">
                            <div class="pdf-preview-container shadow-sm">
                                <iframe id="pdf-preview-2" src="pdfs/operatividad_aerolineas.pdf"></iframe>
                            </div>
                            <button class="btn btn-outline-primary w-100 mt-2" data-fullscreen-target="#pdf-preview-2"><i class="fas fa-expand me-2"></i>Ver en Pantalla Completa</button>
                        </div>
                    </div>
                </div>

                <!-- Manifiestos -->
                <div id="manifiestos-section" class="content-section">
                    <div class="card border-0">
                        <div class="card-header bg-transparent text-center">
                            <h2 class="mb-1 d-inline-flex align-items-center justify-content-center gap-2">
                                <span>Manifiestos</span>
                            </h2>
                            
                        </div>
                        <div class="card-body">
                            <div class="row g-3 manifest-layout">
                                <div class="col-12 col-lg-5">
                                    <div class="manifest-sidebar d-flex flex-column gap-3">
                                        <div class="manifest-pane manifest-pane-controls">
                                            <div class="manifest-controls mb-2 d-flex gap-2 flex-wrap align-items-center">
                                        <input type="file" id="manifest-upload" accept=".pdf,application/pdf,image/*" class="form-control form-control-sm" style="max-width:320px;">
                                        <div class="d-flex gap-2">
                                            <button id="manifest-upload-btn-pdf" type="button" class="btn btn-outline-secondary btn-sm"><i class="fas fa-file-pdf me-1"></i>Adjuntar PDF</button>
                                            <button id="manifest-upload-btn-img" type="button" class="btn btn-outline-secondary btn-sm"><i class="fas fa-image me-1"></i>Adjuntar imagen</button>
                                        </div>
                                        <button id="manifest-scan-pdf" class="btn btn-primary btn-sm ms-2"><i class="fas fa-wand-magic-sparkles me-1"></i>Escanear PDF</button>
                                        <div class="form-check form-switch ms-2">
                                            <input class="form-check-input" type="checkbox" id="manifest-fast-mode" checked>
                                            <label class="form-check-label small" for="manifest-fast-mode" title="Usa texto del PDF primero y OCR dirigido solo si faltan campos clave. Igual de preciso, más rápido.">Modo rápido</label>
                                        </div>
                                        <button id="manifest-scan-ocr" class="btn btn-outline-secondary btn-sm"><i class="fas fa-magic me-1"></i>Escaneo alternativo (OCR)</button>
                                        <select id="manifest-ocr-pages" class="form-select form-select-sm" style="width:auto; display:inline-block">
                                            <option value="1">1 pág</option>
                                            <option value="2" selected>2 págs</option>
                                            <option value="3">3 págs</option>
                                            <option value="5">5 págs</option>
                                        </select>
                                            
                                            </div>
                                            <div class="manifest-mobile-hint small text-muted mb-2">En móviles: usa “Adjuntar PDF” para abrir Archivos/Files y seleccionar documentos .pdf; usa “Adjuntar imagen” para abrir Fotos/Cámara.</div>
                                        </div>
                                        <div class="manifest-pane manifest-pane-preview">
                                            <!-- Progreso estilo avión (arriba de la previsualización) -->
                                            <div id="manifest-plane-progress" class="plane-progress mb-2 d-none" aria-hidden="false">
                                                <div class="plane-progress-track">
                                                    <div class="plane-progress-fill" id="manifest-plane-fill"></div>
                                                    <div class="plane-progress-plane" id="manifest-plane-icon" title="Procesando">✈</div>
                                                </div>
                                                <div class="plane-progress-label small text-muted" id="manifest-plane-label">0%</div>
                                            </div>
                                            <div class="manifest-preview-shell">
                                                <div id="manifest-preview-container" class="manifest-preview-card" style="position:relative; overflow:auto;">
                                                    <!-- Loader de sección Manifiestos (tipo login con avión orbitando) -->
                                                    <div id="manifiestos-loader" class="section-loader hidden" role="alert" aria-live="assertive" aria-busy="true">
                                                        <div class="loader-content text-center">
                                                            <div class="plane-orbit">
                                                                <span class="orbit-ring"></span>
                                                                <span class="plane-icon">✈</span>
                                                                <img src="images/logo_aifa.jpg" alt="AIFA" class="loader-aifa-logo" />
                                                            </div>
                                                            <div class="loader-text">Escaneando…</div>
                                                        </div>
                                                    </div>
                                                    <div id="manifest-preview-placeholder" class="text-muted small">Seleccione un PDF de manifiesto y presione "Escanear PDF" para procesarlo automáticamente.</div>
                                                    <!-- Previsualización: imagen (para JPG/PNG) o canvas (para PDF) -->
                                                    <img id="manifest-preview" alt="Previsualización" class="img-fluid d-none" style="position:relative; z-index:0;" />
                                                    <canvas id="manifest-preview-canvas" class="d-none" style="display:block; margin:auto; position:relative; z-index:1;"></canvas>
                                                    <div id="manifest-text-layer" style="position:absolute; left:0; top:0; right:0; bottom:0; pointer-events:auto; user-select:text; white-space:pre-wrap; overflow:hidden; padding:0.25rem; font: 12px/1.2 'Roboto Mono', monospace; z-index:5;"></div>
                                                </div>
                                            </div>
                                            <div class="manifest-status-stack">
                                                <div id="manifest-ocr-status" class="small text-muted"></div>
                                                <div class="progress my-1 d-none" style="height: 18px;" id="manifest-progress-bar-container">
                                                    <div class="progress-bar progress-bar-striped progress-bar-animated" id="manifest-progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">Escaneando PDF...</div>
                                                </div>
                                                <div id="manifest-pdf-status" class="small text-info"></div>
                                                <details class="mt-1 manifest-debug-toggle">
                                                    <summary class="small">Ver texto detectado (debug)</summary>
                                                    <textarea id="manifest-ocr-debug" class="form-control form-control-sm mt-2" rows="8" style="font-family: 'Roboto Mono', monospace;"></textarea>
                                                </details>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12 col-lg-7">
                                    <div class="manifest-pane manifest-pane-form h-100">
                                        <div class="mf-sheet mf-ntp manifest-form-shell">
                                    <div class="mf-header d-flex align-items-center justify-content-between flex-wrap gap-2">
                                        <div class="d-flex align-items-center gap-2">
                                            <img src="images/logo_aifa.jpg" alt="AIFA" class="mf-header-logo" />
                                            <div>
                                                <div class="mf-header-title">Manifiestos</div>
                                                <div class="mf-header-subtitle">Aeropuerto Internacional Felipe Ángeles</div>
                                            </div>
                                        </div>
                                        <div class="d-flex align-items-end gap-2 mf-header-meta">
                                            <div>
                                                <label class="form-label small mb-1 text-light-ntp">Fecha del Documento</label>
                                                <input type="date" class="form-control form-control-sm mf-header-input" id="mf-doc-date" />
                                            </div>
                                            <div>
                                                <label class="form-label small mb-1 text-light-ntp">Folio</label>
                                                <input type="text" class="form-control form-control-sm mf-header-input" id="mf-folio" />
                                            </div>
                                        </div>
                                    </div>
                                    <form id="manifest-form" class="row g-2 mf-body">
                                        <div class="col-12">
                                            <label class="form-label me-3">Tipo de Manifiesto</label>
                                            <div class="btn-group" role="group" aria-label="Tipo de Manifiesto">
                                                <input type="radio" class="btn-check" name="mf-dir" id="mf-dir-arr" autocomplete="off" checked>
                                                <label class="btn btn-outline-secondary" for="mf-dir-arr"><i class="fas fa-plane-arrival me-1"></i>Llegada</label>
                                                <input type="radio" class="btn-check" name="mf-dir" id="mf-dir-dep" autocomplete="off">
                                                <label class="btn btn-outline-secondary" for="mf-dir-dep"><i class="fas fa-plane-departure me-1"></i>Salida</label>
                                            </div>
                                        </div>
                                            <!-- Encabezado del documento (cuerpo) -->
                                            <div class="col-12">
                                                <div class="d-flex flex-wrap align-items-end gap-3">
                                                    <div class="flex-grow-1">
                                                        <label class="form-label">Título</label>
                                                        <input type="text" class="form-control" id="mf-title" value="MANIFIESTO DE LLEGADA" readonly>
                                                    </div>
                                                </div>
                                                <hr />
                                            </div>
                                        <!-- Sección 1: Datos generales (en orden solicitado) -->
                                        <div class="col-12">
                                            <h6 class="mb-2"><i class="fas fa-list me-1"></i>Datos generales</h6>
                                        </div>
                                        <!-- Nuevos primeros campos en Datos generales -->
                                        <div class="col-12 col-md-6 mb-2">
                                            <label class="form-label" id="mf-airport-main-label">Aeropuerto de Llegada</label>
                                            <input type="text" class="form-control" id="mf-airport-main" placeholder="IATA (3 letras)" maxlength="3" style="text-transform:uppercase" list="airports-iata-list" />
                                        </div>
                                        <div class="col-12 col-md-6 mb-2">
                                            <label class="form-label">Tipo de vuelo</label>
                                            <input type="text" class="form-control" id="mf-flight-type" placeholder="Escribe la letra del tipo (A–Z)" maxlength="1" pattern="[A-Za-z]" style="text-transform:uppercase" list="flight-type-list" autocomplete="off" />
                                            <datalist id="flight-type-list"></datalist>
                                            <div id="mf-flight-type-info" class="form-text small text-muted"></div>
                                        </div>
                                        
                                        <div class="col-12 col-md-4 mb-2">
                                            <label class="form-label">Transportista (OACI - 3 letras)</label>
                                            <input type="text" class="form-control" id="mf-carrier-3l" maxlength="3" placeholder="Ej. AMX" style="text-transform:uppercase" list="airlines-icao-list" pattern="[A-Za-z]{3}" autocomplete="off" />
                                            <datalist id="airlines-icao-list"></datalist>
                                            <div class="form-text">Usa el código OACI (ICAO) de 3 letras. Ejemplos: AMX (Aeroméxico), CLX (Cargolux), THY (Turkish).</div>
                                        </div>
                                        <div class="col-12 col-md-8 mb-2">
                                            <label class="form-label">Nombre o razón social del transportista / operador aéreo</label>
                                            <input type="text" class="form-control" id="mf-operator-name" />
                                        </div>
                                        <div class="col-12 col-md-4 mb-2">
                                            <label class="form-label">Transportista / Operador (Nombre comercial)</label>
                                            <input type="text" class="form-control" id="mf-airline" />
                                        </div>
                                        <div class="col-12 col-md-4 mb-2">
                                            <label class="form-label">Matrícula</label>
                                            <input type="text" class="form-control" id="mf-tail" list="aircraft-reg-list" placeholder="Ej. N851GT / XAABC" style="text-transform:uppercase" autocomplete="off" />
                                            <datalist id="aircraft-reg-list"></datalist>
                                            <div class="form-text">Selecciona una matrícula del catálogo o escríbela manualmente.</div>
                                            <div id="mf-tail-warning" class="form-text text-danger d-none"></div>
                                        </div>
                                        <div class="col-12 col-md-4 mb-2">
                                            <label class="form-label">Vuelo</label>
                                            <input type="text" class="form-control" id="mf-flight" />
                                        </div>
                                        
                                        <div class="col-12 col-md-4 mb-2">
                                            <label class="form-label">Equipo</label>
                                            <input type="text" class="form-control" id="mf-aircraft" list="aircraft-type-icao-list" placeholder="Ej. B77F / A21N / E195" style="text-transform:uppercase" pattern="[A-Za-z0-9]{2,5}" autocomplete="off" />
                                            <datalist id="aircraft-type-icao-list"></datalist>
                                            <div class="form-text">Usa el código OACI del tipo de aeronave (ej. B77F, A21N). Puedes editarlo manualmente.</div>
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="form-label">Piloto al Mando</label>
                                            <input type="text" class="form-control" id="mf-pilot" />
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="form-label">No. de Licencia</label>
                                            <input type="text" class="form-control" id="mf-pilot-license" />
                                        </div>
                                        <div class="col-12 col-md-4">
                                            <label class="form-label">No. de Tripulación</label>
                                            <input type="number" min="0" class="form-control" id="mf-crew-total" />
                                        </div>
                                        
                                        <div class="col-12">
                                            <hr />
                                        </div>
                                        <!-- Sección 2: Movimiento de operaciones (Salida) -->
                                        <div class="col-12" data-dir="departure-only">
                                            <h6 class="mb-2"><i class="fas fa-route me-1"></i>Movimiento de operaciones</h6>
                                            <div class="row g-2">
                                                <!-- Columna 1: Origen -->
                                                <div class="col-12 col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">Origen de vuelo - Nombre completo del aeropuerto</label>
                                                        <input type="text" class="form-control" id="mf-origin-name" list="airports-name-list" placeholder="Nombre completo del aeropuerto" />
                                                        <small class="text-muted">Si es Hangar, agregue "H". Si es Pernocta, agregue "P".</small>
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label">Código de 3 letras (origen)</label>
                                                        <input type="text" class="form-control" id="mf-origin-code" maxlength="3" style="text-transform:uppercase" list="airports-iata-list" placeholder="IATA (3 letras)" />
                                                    </div>
                                                                                                        
                                                </div>
                                                <!-- Columna 2: Próxima escala -->
                                                <div class="col-12 col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">Próxima escala - Nombre completo del aeropuerto</label>
                                                        <input type="text" class="form-control" id="mf-next-stop" list="airports-name-list" placeholder="Nombre completo del aeropuerto" />
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label">Código de 3 letras (próxima escala)</label>
                                                        <input type="text" class="form-control" id="mf-next-stop-code" maxlength="3" style="text-transform:uppercase" list="airports-iata-list" placeholder="IATA (3 letras)" />
                                                    </div>
                                                    
                                                </div>
                                                <!-- Columna 3: Destino -->
                                                <div class="col-12 col-md-4">
                                                    <div class="mb-2">
                                                        <label class="form-label">Destino del vuelo - Nombre completo del aeropuerto</label>
                                                        <input type="text" class="form-control" id="mf-final-dest" list="airports-name-list" placeholder="Nombre completo del aeropuerto" />
                                                    </div>
                                                    <div class="mb-2">
                                                        <label class="form-label">Código de 3 letras (destino)</label>
                                                        <input type="text" class="form-control" id="mf-final-dest-code" maxlength="3" style="text-transform:uppercase" list="airports-iata-list" placeholder="IATA (3 letras)" />
                                                    </div>
                                                    
                                                </div>
                                                <!-- Tipo de Operación (Salida) -->
                                                <div class="col-12 col-md-4 mb-2">
                                                    <label class="form-label">Tipo de Operación</label>
                                                    <input type="text" class="form-control" id="mf-operation-type-dep" placeholder="Doméstica / Internacional" readonly />
                                                    <div class="form-text">Se calcula con los aeropuertos (origen/destino).</div>
                                                </div>
                                                <!-- Grupo de tiempos (Salida) -->
                                                <div class="col-12">
                                                    <div class="p-3 border rounded bg-light-subtle mf-times">
                                                        <h6 class="mb-2">Tiempos (Salida)</h6>
                                                        <div class="row g-2">
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de slot asignado</label>
                                                                <input type="text" class="form-control" id="mf-slot-assigned" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de slot coordinado</label>
                                                                <input type="text" class="form-control" id="mf-slot-coordinated" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de término de pernocta</label>
                                                                <input type="text" class="form-control" id="mf-termino-pernocta" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de inicio de maniobras de embarque</label>
                                                                <input type="text" class="form-control" id="mf-inicio-embarque" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de salida de la posición</label>
                                                                <input type="text" class="form-control" id="mf-salida-posicion" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <hr />
                                        </div>
                                        <!-- Sección 2 (Llegada): Movimiento de operaciones -->
                                        <div class="col-12" data-dir="arrival-only">
                                            <h6 class="mb-2 mf-section-title"><i class="fas fa-route me-1"></i>Movimiento de operaciones</h6>
                                            <div class="row g-2">
                                                <!-- 1) Procedencia del vuelo (nombre completo) -->
                                                <div class="col-12 col-md-6">
                                                    <label class="form-label">Procedencia del vuelo - Nombre completo del aeropuerto</label>
                                                    <input type="text" class="form-control" id="mf-arr-origin-name" list="airports-name-list" placeholder="Nombre completo del aeropuerto" />
                                                </div>
                                                <!-- 2) Código de 3 letras (procedencia) -->
                                                <div class="col-6 col-md-3">
                                                    <label class="form-label">Código de 3 letras (procedencia)</label>
                                                    <input type="text" class="form-control" id="mf-arr-origin-code" maxlength="3" style="text-transform:uppercase" list="airports-iata-list" placeholder="IATA (3 letras)" />
                                                </div>
                                                
                                                <!-- 5) Última escala - nombre completo del aeropuerto -->
                                                <div class="col-12 col-md-6">
                                                    <label class="form-label">Escala Anterior - Nombre completo del aeropuerto</label>
                                                    <input type="text" class="form-control" id="mf-arr-last-stop" list="airports-name-list" placeholder="Nombre completo del aeropuerto" />
                                                </div>
                                                <!-- 6) Código de 3 letras (última escala) -->
                                                <div class="col-6 col-md-3">
                                                    <label class="form-label">Código de 3 letras (escala anterior)</label>
                                                        <input type="text" class="form-control" id="mf-arr-last-stop-code" maxlength="3" style="text-transform:uppercase" list="airports-iata-list" placeholder="IATA (3 letras)" />

                        <datalist id="airports-iata-list"></datalist>
                        <datalist id="airports-name-list"></datalist>
                        <datalist id="hhmm-24-list">
                            <!-- 24h options in 5-minute increments for convenience; you can still type any minute -->

                        </datalist>
                                                </div>
                                                <!-- Tipo de Operación (Llegada) -->
                                                <div class="col-12 col-md-4 mb-2">
                                                    <label class="form-label">Tipo de Operación</label>
                                                    <input type="text" class="form-control" id="mf-operation-type-arr" placeholder="Doméstica / Internacional" readonly />
                                                    <div class="form-text">Se calcula con los aeropuertos (procedencia/escala).</div>
                                                </div>
                                                
                                                <!-- Grupo de tiempos (Llegada) -->
                                                <div class="col-12 mt-1">
                                                    <div class="p-3 border rounded bg-light-subtle mf-times">
                                                        <h6 class="mb-2 mf-section-title">Tiempos (Llegada)</h6>
                                                        <div class="row g-2">
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de slot asignado</label>
                                                                <input type="text" class="form-control" id="mf-arr-slot-assigned" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <label class="form-check-label ms-2 d-inline-flex align-items-center"><input type="checkbox" class="form-check-input me-1" id="mf-arr-slot-assigned-na" title="No aplica (N/A)">N/A</label>
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de slot coordinado</label>
                                                                <input type="text" class="form-control" id="mf-arr-slot-coordinated" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <label class="form-check-label ms-2 d-inline-flex align-items-center"><input type="checkbox" class="form-check-input me-1" id="mf-arr-slot-coordinated-na" title="No aplica (N/A)">N/A</label>
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de entrada a la posición</label>
                                                                <input type="text" class="form-control" id="mf-arr-arribo-posicion" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <label class="form-check-label ms-2 d-inline-flex align-items-center"><input type="checkbox" class="form-check-input me-1" id="mf-arr-arribo-posicion-na" title="No aplica (N/A)">N/A</label>
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de termino de maniobras de desembarque</label>
                                                                <input type="text" class="form-control" id="mf-arr-inicio-desembarque" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <label class="form-check-label ms-2 d-inline-flex align-items-center"><input type="checkbox" class="form-check-input me-1" id="mf-arr-inicio-desembarque-na" title="No aplica (N/A)">N/A</label>
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                            <div class="col-6 col-md-3">
                                                                <label class="form-label">Hora de inicio de pernocta</label>
                                                                <input type="text" class="form-control" id="mf-arr-inicio-pernocta" data-time24="1" inputmode="numeric" placeholder="HH:MM" maxlength="5" />
                                                                <label class="form-check-label ms-2 d-inline-flex align-items-center"><input type="checkbox" class="form-check-input me-1" id="mf-arr-inicio-pernocta-na" title="No aplica (N/A)">N/A</label>
                                                                <div class="form-text">Hora local</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- 9) Hora de inicio de pernocta -->
                                                
                                            </div>
                                            <hr />
                                        </div>
                                        
                                        <!-- Causas de la demora (3 filas fijas) -->
                                        <div class="col-12">
                                            <h6 class="mb-2 mf-section-title"><i class="fas fa-clock me-1"></i>Causas de la demora</h6>
                                            <div class="row g-2 align-items-end mb-1">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label">Código de demora</label>
                                                    <input type="text" class="form-control" id="demora1-codigo" list="delay-alpha-codes" placeholder="Escribe código (Alpha)" maxlength="3" autocomplete="off">
                                                </div>
                                                <div class="col-6 col-md-2">
                                                    <label class="form-label">Tiempo (min)</label>
                                                    <input type="number" min="0" class="form-control" id="demora1-tiempo" placeholder="0">
                                                </div>
                                                <div class="col-12 col-md-7">
                                                    <label class="form-label">Descripción</label>
                                                    <input type="text" class="form-control" id="demora1-descripcion" placeholder="Descripción del código">
                                                </div>
                                            </div>
                                            <div class="row g-2 align-items-end mb-1">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label">Código de demora</label>
                                                    <input type="text" class="form-control" id="demora2-codigo" list="delay-alpha-codes" placeholder="Escribe código (Alpha)" maxlength="3" autocomplete="off">
                                                </div>
                                                <div class="col-6 col-md-2">
                                                    <label class="form-label">Tiempo (min)</label>
                                                    <input type="number" min="0" class="form-control" id="demora2-tiempo" placeholder="0">
                                                </div>
                                                <div class="col-12 col-md-7">
                                                    <label class="form-label">Descripción</label>
                                                    <input type="text" class="form-control" id="demora2-descripcion" placeholder="Descripción del código">
                                                </div>
                                            </div>
                                            <div class="row g-2 align-items-end mb-2">
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label">Código de demora</label>
                                                    <input type="text" class="form-control" id="demora3-codigo" list="delay-alpha-codes" placeholder="Escribe código (Alpha)" maxlength="3" autocomplete="off">
                                                </div>
                                                <div class="col-6 col-md-2">
                                                    <label class="form-label">Tiempo (min)</label>
                                                    <input type="number" min="0" class="form-control" id="demora3-tiempo" placeholder="0">
                                                </div>
                                                <div class="col-12 col-md-7">
                                                    <label class="form-label">Descripción</label>
                                                    <input type="text" class="form-control" id="demora3-descripcion" placeholder="Descripción del código">
                                                </div>
                                            </div>
                                            <!-- Datalist para códigos de demora (Alpha code) con Description -->
                                            <datalist id="delay-alpha-codes"></datalist>
                                            <hr />
                                        </div>

                                        <!-- División: Pasajeros por categoría (después de Demoras) -->
                                        <div class="col-12" data-dir="departure-only">
                                            <h6 class="mb-2 mf-section-title"><i class="fas fa-people-group me-1"></i>Pasajeros por categoría</h6>
                                            <div class="row g-2">
                                                <div class="col-6 col-md-3"><label class="form-label">Pagan TUA</label><input type="number" min="0" class="form-control" id="pax-tua"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">Diplomáticos</label><input type="number" min="0" class="form-control" id="pax-diplomaticos"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">En comisión</label><input type="number" min="0" class="form-control" id="pax-comision"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">Infantes</label><input type="number" min="0" class="form-control" id="pax-infantes"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">Tránsitos</label><input type="number" min="0" class="form-control" id="pax-transitos"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">Conexiones</label><input type="number" min="0" class="form-control" id="pax-conexiones"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">Otros exentos</label><input type="number" min="0" class="form-control" id="pax-exentos"></div>
                                                <div class="col-6 col-md-3"><label class="form-label">Total</label><input type="number" min="0" class="form-control" id="pax-total" readonly></div>
                                            </div>
                                            <div class="row g-2 mt-1">
                                                <div class="col-12 col-md-6"><div class="form-text">Nacionales</div></div>
                                                <div class="col-12 col-md-6"><div class="form-text">Internacionales</div></div>
                                            </div>
                                            <hr />
                                        </div>
                                        
                                        <!-- Embarque por estación -->
                                        <div class="col-12" data-dir="departure-only">
                                            <div class="d-flex align-items-center justify-content-between">
                                                <h6 class="mb-2 mf-section-title"><i class="fas fa-people-carry-box me-1"></i>Tabla de embarque por estación</h6>
                                                <div class="d-flex gap-2">
                                                    <button type="button" id="add-embarque-row" class="btn btn-sm btn-outline-secondary"><i class="fas fa-plus me-1"></i>Agregar estación</button>
                                                    <button type="button" id="clear-embarque" class="btn btn-sm btn-outline-secondary"><i class="fas fa-trash me-1"></i>Limpiar</button>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table class="table table-sm align-middle" id="tabla-embarque">
                                                    <thead>
                                                        <tr>
                                                            <th>Estación</th>
                                                            <th style="width:140px;">Pax Nacional</th>
                                                            <th style="width:160px;">Pax Internacional</th>
                                                            <th style="width:140px;">Equipaje (kg)</th>
                                                            <th style="width:140px;">Carga (kg)</th>
                                                            <th style="width:140px;">Correo (kg)</th>
                                                            <th style="width:60px;"></th>
                                                        </tr>
                                                    </thead>
                                                    <tbody></tbody>
                                                    <tfoot>
                                                        <tr class="table-light">
                                                            <th>Totales</th>
                                                            <th><input type="number" class="form-control form-control-sm" id="total-pax-nacional" readonly></th>
                                                            <th><input type="number" class="form-control form-control-sm" id="total-pax-internacional" readonly></th>
                                                            <th><input type="text" class="form-control form-control-sm" id="total-equipaje" readonly></th>
                                                            <th><input type="text" class="form-control form-control-sm" id="total-carga" readonly></th>
                                                            <th><input type="text" class="form-control form-control-sm" id="total-correo" readonly></th>
                                                            <th></th>
                                                        </tr>
                                                    </tfoot>
                                                </table>
                                            </div>
                                            <hr />
                                        </div>
                                        <div class="col-6 col-md-4" data-dir="departure-only">
                                            <label class="form-label">Equipaje Piezas</label>
                                            <input type="number" class="form-control" id="mf-baggage-pcs" />
                                        </div>
                                        <div class="col-6 col-md-4" data-dir="departure-only">
                                            <label class="form-label">Carga (kg)</label>
                                            <input type="number" step="0.01" class="form-control" id="mf-cargo" />
                                        </div>
                                        <div class="col-6 col-md-4" data-dir="departure-only">
                                            <label class="form-label">Carga Piezas</label>
                                            <input type="number" class="form-control" id="mf-cargo-pieces" />
                                        </div>
                                        <div class="col-6 col-md-4" data-dir="departure-only">
                                            <label class="form-label">Volumen (m³)</label>
                                            <input type="number" step="0.01" class="form-control" id="mf-cargo-volume" />
                                        </div>
                                        <div class="col-6 col-md-4" data-dir="departure-only">
                                            <label class="form-label">Correo (kg)</label>
                                            <input type="number" step="0.01" class="form-control" id="mf-mail" />
                                        </div>
                                        <div class="col-6 col-md-4" data-dir="departure-only">
                                            <label class="form-label">Correo Piezas</label>
                                            <input type="number" class="form-control" id="mf-mail-pieces" />
                                        </div>
                                        <div class="col-12" data-dir="departure-only">
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="mf-dangerous-goods">
                                                <label class="form-check-label" for="mf-dangerous-goods">Mercancías Peligrosas</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="mf-live-animals">
                                                <label class="form-check-label" for="mf-live-animals">Animales Vivos</label>
                                            </div>
                                            <div class="form-check form-check-inline">
                                                <input class="form-check-input" type="checkbox" id="mf-human-remains">
                                                <label class="form-check-label" for="mf-human-remains">Restos Humanos</label>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <hr />
                                        </div>
                                        <div class="col-12 col-md-6" data-dir="departure-only">
                                            <label class="form-label">Agente / Responsable</label>
                                            <input type="text" class="form-control" id="mf-agent" />
                                        </div>
                                        <div class="col-12 col-md-6" data-dir="departure-only">
                                            <label class="form-label">Nombre y Firma</label>
                                            <input type="text" class="form-control" id="mf-signature" />
                                        </div>
                                        <div class="col-12" data-dir="departure-only">
                                            <div class="row g-2">
                                                <div class="col-12">
                                                    <label class="form-label">Observaciones</label>
                                                    <textarea class="form-control" id="mf-notes" rows="2"></textarea>
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <label class="form-label">Carga en tránsito (destino/procedencia)</label>
                                                    <input type="text" class="form-control" id="mf-obs-transito" />
                                                </div>
                                                <div class="col-12 col-md-6">
                                                    <label class="form-label">PAX DNI</label>
                                                    <input type="text" class="form-control" id="mf-pax-dni" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12">
                                            <hr />
                                        </div>
                                        <!-- Firmas y sellos -->
                                        <div class="col-12" data-dir="departure-only">
                                            <h6 class="mb-2 mf-section-title"><i class="fas fa-signature me-1"></i>Firmas y sellos</h6>
                                            <div class="row g-2">
                                                <div class="col-12 col-md-4">
                                                    <label class="form-label">Operador (Nombre y Firma)</label>
                                                    <input type="text" class="form-control" id="mf-sign-operator" />
                                                </div>
                                                <div class="col-12 col-md-4">
                                                    <label class="form-label">Coordinador de Rampa (Nombre y Firma)</label>
                                                    <input type="text" class="form-control" id="mf-sign-coordinator" />
                                                </div>
                                                <div class="col-12 col-md-4">
                                                    <label class="form-label">Administrador AIFA - Recibido por</label>
                                                    <input type="text" class="form-control" id="mf-sign-admin" />
                                                </div>
                                                <div class="col-12 col-md-3">
                                                    <label class="form-label">Fecha de Recepción</label>
                                                    <input type="date" class="form-control" id="mf-sign-admin-date" />
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 d-flex gap-2 mt-2">
                                            <button type="button" class="btn btn-success" id="manifest-save"><i class="fas fa-save me-1"></i>Guardar</button>
                                            <button type="button" class="btn btn-outline-secondary" id="manifest-clear"><i class="fas fa-eraser me-1"></i>Limpiar</button>
                                            <button type="button" class="btn btn-outline-success" id="manifest-add-to-table" title="Agregar el formulario actual a la tabla (sin guardar)"><i class="fas fa-plus me-1"></i>Añadir a tabla</button>
                                            <button type="button" class="btn btn-outline-primary ms-auto" id="manifest-export-csv" title="Exportar registros rellenados a Excel"><i class="fas fa-file-excel me-1"></i>Exportar Excel</button>
                                        </div>
                                    </form>
                                    </div>
                                    <div class="manifest-records-block mt-3">
                                        <hr />
                                        <h5 class="mb-2">Registros Guardados</h5>
                                        <p class="text-muted small mt-n2 mb-3">Tip: Usa “Añadir a tabla” para agregar el formulario actual aquí sin guardarlo; “Exportar Excel” exporta esta tabla tal cual se ve.</p>
                                        <div class="table-responsive">
                                            <table class="table table-sm table-hover align-middle" id="manifest-records-table">
                                                <thead>
                                                    <tr>
                                                        <th>Tipo</th>
                                                        <th>Aerolínea</th>
                                                        <th>Vuelo</th>
                                                        <th>Matrícula</th>
                                                        <th>Fecha</th>
                                                        <th>Hora</th>
                                                        <th>Origen/Destino</th>
                                                        <th>Pax</th>
                                                        <th>Carga/Correo</th>
                                                        <th>Imagen</th>
                                                    </tr>
                                                </thead>
                                                <tbody></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                

            </main>
        </div>
    </div>

    <div id="pdf-lightbox" class="pdf-lightbox hidden">
        <button id="lightbox-close" class="lightbox-close">&times;</button>
        <div id="lightbox-content" class="lightbox-content"></div>
    </div>

    <!-- Modal: Selección de dirección del vuelo (Llegada/Salida) -->
    <div class="modal fade" id="mfDirectionModal" tabindex="-1" aria-labelledby="mfDirectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mfDirectionModalLabel"><i class="fas fa-plane me-2"></i>¿Qué tipo de documento es?</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-3">Selecciona la dirección del vuelo para completar el manifiesto.</p>
                    <div class="d-flex gap-2">
                        <button type="button" id="mfDirChooseArr" class="btn btn-primary flex-fill"><i class="fas fa-plane-arrival me-1"></i>Llegada</button>
                        <button type="button" id="mfDirChooseDep" class="btn btn-success flex-fill"><i class="fas fa-plane-departure me-1"></i>Salida</button>
                    </div>
                    <div class="form-text mt-2">Puedes cambiarlo después si es necesario.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 2050">
        <div id="action-toast" class="toast align-items-center text-bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">Filtros limpiados</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Cerrar"></button>
            </div>
        </div>
    </div>

        <!-- Time Picker Modal (24h) -->
        <div class="modal fade" id="timePickerModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" style="max-width:360px">
                <div class="modal-content">
                    <div class="modal-header py-2">
                        <h6 class="modal-title"><i class="fas fa-clock me-2"></i>Seleccionar hora (24h)</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <div class="w-50 pe-1">
                                <label class="form-label small">Horas (00–23)</label>
                                <input type="number" min="0" max="23" step="1" class="form-control" id="tp-hours" value="00">
                            </div>
                            <div class="w-50 ps-1">
                                <label class="form-label small">Minutos (00–59)</label>
                                <input type="number" min="0" max="59" step="1" class="form-control" id="tp-mins" value="00">
                            </div>
                        </div>
                        <div class="d-flex flex-wrap gap-1 mt-2">
                            <div class="small text-muted">Atajos:</div>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tp="00:00">00:00</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tp="06:00">06:00</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tp="12:00">12:00</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tp="18:00">18:00</button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" data-tp="23:59">23:59</button>
                        </div>
                    </div>
                    <div class="modal-footer py-2">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" id="tp-apply">Aplicar</button>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

    <!-- SheetJS (XLSX) para exportar manifiestos a Excel en el cliente -->
    <!-- Cargar desde CDN; si no hay red, la exportación caerá a CSV automáticamente -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Fallbacks y manejador de errores de imágenes (se define antes de script.js) -->
    <script>
        // Wire "Ver en Pantalla Completa" button to open iframe src in a new tab (mobile-friendly)
        (function(){
            document.addEventListener('DOMContentLoaded', function(){
                document.querySelectorAll('[data-fullscreen-target]').forEach(btn => {
                    if (btn._wiredFullscreen) return; btn._wiredFullscreen = true;
                    btn.addEventListener('click', function(){
                        const sel = btn.getAttribute('data-fullscreen-target');
                        if (!sel) return;
                        const iframe = document.querySelector(sel);
                        const url = iframe && iframe.getAttribute('src');
                        if (url) {
                            // Construye URL absoluta para que funcione bajo file:// y http(s)
                            const fullUrl = new URL(url, window.location.href).href;
                            window.open(fullUrl, '_blank');
                        }
                    });
                });
            });
        })();
    </script>
    <script>
        (function () {
            // Fallback para renderDemoras si no existe
            if (typeof window.renderDemoras !== 'function') {
                window.renderDemoras = function (data) {
                    console.warn('renderDemoras() fallback ejecutado.');
                    try {
                        const tbody = document.getElementById('demoras-tbody');
                        const tfoot = document.getElementById('demoras-tfoot');
                        if (!tbody) return;

                        tbody.innerHTML = '';
                        let total = 0;

                        if (Array.isArray(data)) {
                            data.forEach(row => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `
                                    <td>${row?.causa ?? '—'}</td>
                                    <td>${row?.demoras ?? 0}</td>
                                    <td>${row?.porcentaje ?? 0}%</td>`;
                                tbody.appendChild(tr);
                                total += Number(row?.demoras ?? 0);
                            });
                        }

                        if (tfoot) {
                            tfoot.innerHTML = `<tr class="table-light"><th>Total</th><th>${total}</th><th></th></tr>`;
                        }

                        // Crea una gráfica simple si hay datos y canvas disponible
                        const ctx = document.getElementById('delaysChart')?.getContext?.('2d');
                        if (ctx && window.Chart && !window._delaysChart) {
                            const labels = (data || []).map(r => r?.causa ?? '');
                            const values = (data || []).map(r => Number(r?.demoras ?? 0));
                            window._delaysChart = new Chart(ctx, {
                                type: 'bar',
                                data: {
                                    labels,
                                    datasets: [{
                                        label: 'Demoras',
                                        data: values,
                                        backgroundColor: '#0d6efd77',
                                        borderColor: '#0d6efd'
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: { legend: { display: false } }
                                }
                            });
                        }
                    } catch (err) {
                        console.error('Fallback renderDemoras error:', err);
                    }
                };
            }

            // Fallback para computeDailyStats si no existe
            if (typeof window.computeDailyStats !== 'function') {
                window.computeDailyStats = function (itinerary) {
                    console.warn('computeDailyStats() fallback ejecutado.');
                    // Devuelve estructura mínima para no romper la UI; reemplace con lógica real en script.js
                    return {
                        comercial: { ayer: 0, hoy: 0, trend: '=' },
                        carga: { ayer: 0, hoy: 0, trend: '=' },
                        general: { ayer: 0, hoy: 0, trend: '=' }
                    };
                };
            }

            // Reemplazo global de imágenes que fallen (ej. logos de aerolíneas faltantes)
            document.addEventListener('error', function (e) {
                const t = e.target;
                if (t && t.tagName === 'IMG') {
                    // Deja que las imágenes de aerolíneas usen su propio fallback (handleLogoError)
                    if (t.classList && t.classList.contains('airline-logo')) return;
                    // Evita loops infinitos
                    if (t.dataset.fallbackApplied === '1') return;
                    t.dataset.fallbackApplied = '1';
                    console.warn('Reemplazando imagen no encontrada:', t.src);
                    // Usar fallback local consistente (evita dominios externos)
                    t.src = 'images/airlines/default-airline-logo.svg';
                }
            }, true);

            // Fallback de inicio de sesión: DESHABILITADO por seguridad (no se permite auto-login ni bypass del manejador principal)
            // Este bloque se dejó intencionalmente vacío.
        })();
    </script>

    
    <!-- Modular JS (non-invasive): delegates to existing functions in script.js -->
    <script src="js/core.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/inicio.js"></script>
    <script src="js/itinerario.js"></script>
    <script src="js/demoras.js"></script>
    <script src="js/operaciones.js"></script>
    <script src="js/frecuencias.js"></script>
    <script src="js/manifiestos.js"></script>
    <script src="js/fauna.js"></script>
    
        <script src="script.js"></script>
        <script src="js/puntualidad.js"></script>
        <script>
            // Modo DEV: bloquear por completo el registro de Service Workers en localhost/127.0.0.1 o con bandera noSW
            (function noSWDevGuard(){
                try {
                    const params = new URLSearchParams(location.search);
                    const flag = params.get('noSW') === '1' || localStorage.getItem('aifa.noSW') === '1';
                    const isLocalHost = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname) || location.protocol === 'file:';
                    const devNoSW = flag || isLocalHost;
                    if (!devNoSW) { window.__NO_SW__ = false; return; }
                    window.__NO_SW__ = true;
                    if (navigator.serviceWorker && typeof navigator.serviceWorker.register === 'function') {
                        const sw = navigator.serviceWorker;
                        const originalRegister = sw.register.bind(sw);
                        sw.register = async function(){
                            console.warn('[noSW] Registro de Service Worker bloqueado en modo dev');
                            throw new Error('Dev mode: Service Worker disabled');
                        };
                        // Opcional: informar si algún script intenta registrar
                        console.info('[noSW] Modo DEV activo: Service Worker deshabilitado (host local o flag noSW)');
                    }
                } catch(e) { /* noop */ }
            })();
        </script>
        <script>
            // Mostrar advertencia si se abre con file:// (CORS bloqueará fetch de CSV/JSON)
            (function warnIfFileProtocol(){
                try{
                    if (location.protocol === 'file:'){
                        const el = document.getElementById('file-protocol-warning');
                        if (el) el.classList.remove('d-none');
                    }
                }catch(_){}
            })();
        </script>
        <script>
            // Asegurar que el overlay del sidebar nunca quede activo por error al cargar
            (function ensureOverlayOff(){
                try{
                    const ov = document.getElementById('sidebar-overlay');
                    if (ov) ov.classList.remove('active');
                }catch(_){}
            })();
        </script>
        <script>
            // Limpieza agresiva de Service Workers previos y caches.
            // Si se detecta alguno, se hace reload UNA sola vez para que dejen de interceptar inmediatamente.
            (async function cleanupSW(){
                try {
                    const params = new URLSearchParams(location.search);
                    const flag = params.get('noSW') === '1' || localStorage.getItem('aifa.noSW') === '1';
                    const isLocalHost = /^(localhost|127\.0\.0\.1)$/i.test(location.hostname) || location.protocol === 'file:';
                    const devNoSW = flag || isLocalHost;
                    if (!devNoSW) return; // Solo en modo DEV
                    const FLAG = 'aifa.sw.cleaned.once';
                    const already = sessionStorage.getItem(FLAG) === '1';
                    if ('serviceWorker' in navigator) {
                        const regs = await navigator.serviceWorker.getRegistrations().catch(()=>[]);
                        if (Array.isArray(regs) && regs.length) {
                            await Promise.all(regs.map(r=>r.unregister().catch(()=>{})));
                            if (window.caches && caches.keys) {
                                try { const keys = await caches.keys(); await Promise.all(keys.map(k => caches.delete(k))); } catch(_) {}
                            }
                            if (!already) {
                                sessionStorage.setItem(FLAG, '1');
                                // Forzar un refresco inmediato para que el SW deje de interceptar en esta sesión
                                location.reload();
                                return;
                            }
                        }
                    }
                    // Reset de bandera cuando ya no hay SWs activos
                    if (already && (!('serviceWorker' in navigator))) {
                        sessionStorage.removeItem(FLAG);
                    }
                } catch(_) {}
            })();

            // Evitar errores de PDFs cuando no hay conexión: quitar src hasta que haya red
            (function managePDFs(){
                function applyOnlineState(){
                    const frames = document.querySelectorAll('iframe[src$=\".pdf\"]');
                    if (!navigator.onLine) {
                        frames.forEach(f => {
                            if (!f.dataset.src) f.dataset.src = f.getAttribute('src') || '';
                            f.removeAttribute('src');
                            // Mostrar un placeholder breve
                            if (!f._ph) {
                                const ph = document.createElement('div');
                                ph.className = 'text-muted small';
                                ph.textContent = 'PDF no disponible sin conexión';
                                f.parentElement && f.parentElement.appendChild(ph);
                                f._ph = ph;
                            }
                        });
                    } else {
                        frames.forEach(f => {
                            if (f.dataset.src && !f.getAttribute('src')) {
                                f.setAttribute('src', f.dataset.src);
                            }
                            if (f._ph) { try { f._ph.remove(); } catch(_) {} f._ph = null; }
                        });
                    }
                }
                window.addEventListener('online', applyOnlineState);
                window.addEventListener('offline', applyOnlineState);
                applyOnlineState();
            })();
        </script>
        <script>
            // Ajustar la paleta del login según el color medio del video de fondo
            (function adaptLoginPaletteToVideo(){
                const video = document.getElementById('login-bg-video');
                if (!video) return;
                const root = document.documentElement;
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext && canvas.getContext('2d', { willReadFrequently: true });
                if (!ctx) return;

                const clamp = (v)=> Math.max(0, Math.min(255, Math.round(v)));
                const lighten = (rgb, amount)=> rgb.map(ch => clamp(ch + (255 - ch) * amount));
                const darken = (rgb, amount)=> rgb.map(ch => clamp(ch * (1 - amount)));
                const rgba = (rgb, alpha)=> `rgba(${clamp(rgb[0])},${clamp(rgb[1])},${clamp(rgb[2])},${alpha})`;

                let sampling = false;
                let lastApplied = null;

                function applyPalette(avg){
                    const [r,g,b] = avg.map(clamp);
                    const luminance = (0.299*r + 0.587*g + 0.114*b) / 255;
                    const isBright = luminance > 0.55;

                    const base = darken(avg, 0.18);
                    const edge = lighten(avg, 0.25);
                    const highlight1 = lighten(avg, 0.48);
                    const highlight2 = lighten(avg, 0.68);
                    const frame = lighten(avg, 0.32);
                    const formBgColor = isBright ? darken(avg, 0.12) : darken(avg, 0.42);
                    const formBgAlpha = isBright ? 0.28 : 0.4;
                    const formBorder = lighten(avg, isBright ? 0.22 : 0.58);
                    const textRGB = isBright ? darken(avg, 0.68) : lighten(avg, 0.92);
                    const labelRGB = isBright ? darken(avg, 0.46) : lighten(avg, 0.82);
                    const helperRGB = isBright ? darken(avg, 0.36) : lighten(avg, 0.74);

                    root.style.setProperty('--login-glass-base', rgba(base, 0.52));
                    root.style.setProperty('--login-glass-edge', rgba(edge, 0.24));
                    root.style.setProperty('--login-glass-highlight-1', rgba(highlight1, 0.32));
                    root.style.setProperty('--login-glass-highlight-2', rgba(highlight2, 0.22));
                    root.style.setProperty('--login-glass-frame', rgba(frame, 0.26));
                    root.style.setProperty('--login-form-bg', rgba(formBgColor, formBgAlpha));
                    root.style.setProperty('--login-form-border', rgba(formBorder, 0.24));
                    root.style.setProperty('--login-form-text', rgba(textRGB, 0.96));
                    root.style.setProperty('--login-label-color', rgba(labelRGB, 0.88));
                    root.style.setProperty('--login-helper-color', rgba(helperRGB, 0.78));
                }

                function sampleFrame(){
                    if (sampling) return;
                    sampling = true;
                    requestAnimationFrame(()=>{
                        try {
                            if (!video.videoWidth || !video.videoHeight){ sampling = false; return; }
                            const targetWidth = 140;
                            const targetHeight = Math.max(1, Math.round((video.videoHeight / video.videoWidth) * targetWidth));
                            canvas.width = targetWidth;
                            canvas.height = targetHeight;
                            ctx.drawImage(video, 0, 0, targetWidth, targetHeight);
                            const { data } = ctx.getImageData(0, 0, targetWidth, targetHeight);
                            let r = 0, g = 0, b = 0, count = 0;
                            for (let i=0; i<data.length; i+=4){
                                const alpha = data[i+3];
                                if (alpha < 32) continue;
                                r += data[i];
                                g += data[i+1];
                                b += data[i+2];
                                count++;
                            }
                            if (count){
                                const avg = [r/count, g/count, b/count];
                                const key = avg.map(v=> clamp(v)).join(',');
                                if (key !== lastApplied){
                                    applyPalette(avg);
                                    lastApplied = key;
                                }
                            }
                        } catch(_){ /* ignore sampling errors */ }
                        sampling = false;
                    });
                }

                const triggerSample = ()=> sampleFrame();
                if (video.readyState >= 2){ triggerSample(); }
                else video.addEventListener('loadeddata', triggerSample, { once: true });

                ['play','playing','timeupdate'].forEach(evt =>{
                    video.addEventListener(evt, triggerSample, { passive: true });
                });
            })();
        </script>
    <!-- Loader Global -->
    <div id="global-loader" class="global-loader hidden" role="alert" aria-live="assertive" aria-busy="true">
        <div class="loader-content">
            <div class="plane-orbit">
                <span class="orbit-ring"></span>
                <span class="plane-icon">✈</span>
                <img src="images/logo_aifa.jpg" alt="AIFA" class="loader-aifa-logo" />
            </div>
            <div class="loader-text" id="global-loader-text">Cargando...</div>
        </div>
    </div>
</body>
</html>