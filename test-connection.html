<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIFA Operaciones - Diagnóstico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <style>
        body {
            background-color: #f0f4f8;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dbeafe' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .card-header-custom {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
        }
        .avatar-circle {
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #495057;
        }
        .logo-icon {
            width: 64px;
            height: 64px;
        }
    </style>
</head>
<body class="bg-light d-flex align-items-center min-vh-100">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6 col-xl-5">
                
                <div class="text-center mb-4">
                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm mb-3 logo-icon">
                        <i class="fas fa-plane-departure fa-2x"></i>
                    </div>
                    <h2 class="fw-bold text-dark">AIFA Operaciones</h2>
                    <p class="text-muted small text-uppercase letter-spacing-2">Diagnóstico de Conexión</p>
                </div>

                <!-- Card Principal -->
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                    <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
                        <div id="status" class="alert alert-light border d-flex align-items-center small mb-0" role="alert">
                            <i class="fas fa-spinner fa-spin me-2 text-primary"></i>
                            <div class="text-muted">Iniciando sistema...</div>
                        </div>
                    </div>

                    <div class="card-body p-4">
                        
                        <!-- Tabs de Navegación -->
                        <ul class="nav nav-pills nav-fill mb-4 p-1 bg-light rounded-pill" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active rounded-pill small fw-bold" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab" aria-controls="pills-login" aria-selected="true">
                                    <i class="fas fa-sign-in-alt me-2"></i>Acceso
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link rounded-pill small fw-bold" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register" type="button" role="tab" aria-controls="pills-register" aria-selected="false">
                                    <i class="fas fa-user-plus me-2"></i>Registro
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="pills-tabContent">
                            <!-- Login -->
                            <div class="tab-pane fade show active" id="pills-login" role="tabpanel">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" id="username" placeholder="Usuario">
                                    <label for="username" class="text-muted"><i class="fas fa-user me-2"></i>Usuario</label>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control bg-light border-0" id="password" placeholder="Contraseña">
                                    <label for="password" class="text-muted"><i class="fas fa-lock me-2"></i>Contraseña</label>
                                </div>
                                <button class="btn btn-primary w-100 py-3 rounded-3 fw-bold shadow-sm" onclick="testLogin()">
                                    <i class="fas fa-paper-plane me-2"></i>INICIAR SESIÓN
                                </button>
                            </div>

                            <!-- Registro -->
                            <div class="tab-pane fade" id="pills-register" role="tabpanel">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" id="reg-username" placeholder="Usuario">
                                    <label for="reg-username" class="text-muted"><i class="fas fa-user me-2"></i>Usuario</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control bg-light border-0" id="reg-email" placeholder="Correo electrónico (Opcional)">
                                    <label for="reg-email" class="text-muted"><i class="fas fa-envelope me-2"></i>Correo (Opcional)</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" id="reg-fullname" placeholder="Nombre Completo">
                                    <label for="reg-fullname" class="text-muted"><i class="fas fa-id-card me-2"></i>Nombre Completo</label>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control bg-light border-0" id="reg-password" placeholder="Contraseña">
                                    <label for="reg-password" class="text-muted"><i class="fas fa-lock me-2"></i>Contraseña</label>
                                </div>
                                <button class="btn btn-success w-100 py-3 rounded-3 fw-bold shadow-sm" onclick="testRegister()">
                                    <i class="fas fa-user-check me-2"></i>CREAR CUENTA
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sesión Actual (Overlay o Card inferior) -->
                <div id="user-section" class="card shadow-sm border-0 mt-4 d-none rounded-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success bg-opacity-10 text-success rounded-circle p-3 me-3">
                                <i class="fas fa-user-shield fa-2x"></i>
                            </div>
                            <div class="overflow-hidden">
                                <h6 class="mb-1 fw-bold text-dark" id="user-email">usuario@aifa.operaciones</h6>
                                <div class="badge bg-light text-secondary border" id="user-id">ID: ...</div>
                            </div>
                        </div>
                        
                        <div class="badge bg-primary bg-opacity-10 text-primary mb-3 p-2 w-100 rounded-3" id="user-role">
                            <i class="fas fa-spinner fa-spin me-1"></i> Verificando rol...
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100 btn-sm py-2" onclick="testRead()">
                                    <i class="fas fa-database me-1"></i>Test DB
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100 btn-sm py-2" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-1"></i>Salir
                                </button>
                            </div>
                        </div>
                        <div id="data-result" class="mt-3 small text-center"></div>
                    </div>
                </div>

                <div class="text-center mt-4 text-muted small">
                    &copy; 2025 AIFA Operaciones &bull; v1.0.0
                </div>

            </div>
        </div>
    </div>

    <script>
        async function checkSession() {
            if (!window.supabaseClient) {
                updateStatus('danger', 'Error: window.supabaseClient no está definido.');
                return;
            }
            updateStatus('success', 'Cliente Supabase listo. Conectado.');

            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (session) {
                showUser(session.user);
            }
        }

        function updateStatus(type, msg) {
            const el = document.getElementById('status');
            el.className = `alert alert-${type} d-flex align-items-center`;
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'danger') icon = 'exclamation-triangle';
            if (type === 'warning') icon = 'exclamation-circle';
            
            el.innerHTML = `<i class="fas fa-${icon} me-2"></i><div>${msg}</div>`;
        }

        async function testLogin() {
            let username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            updateStatus('info', 'Autenticando...');

            try {
                if (!username.includes('@')) {
                    const normalized = username.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '.');
                    username = `${normalized}@aifa.operaciones`;
                }

                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: username,
                    password
                });

                if (error) throw error;
                
                updateStatus('success', '¡Bienvenido a bordo! Login correcto.');
                showUser(data.user);

            } catch (err) {
                updateStatus('danger', 'Error de autenticación: ' + err.message);
            }
        }

        async function testRegister() {
            let username = document.getElementById('reg-username').value;
            const emailInput = document.getElementById('reg-email').value;
            const fullName = document.getElementById('reg-fullname').value;
            const password = document.getElementById('reg-password').value;

            if (!username || !password) {
                alert('Usuario y contraseña requeridos');
                return;
            }

            updateStatus('info', 'Registrando nuevo tripulante...');

            try {
                // If explicit email provided, use it. Otherwise generate dummy.
                let email = emailInput ? emailInput.trim() : username;
                
                // If username is not an email and no email provided, create dummy
                if (!email.includes('@')) {
                    const normalized = username.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '.');
                    email = `${normalized}@aifa.operaciones`;
                }

                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: { 
                        data: { 
                            full_name: fullName,
                            username: username // Store the display username 
                        } 
                    }
                });

                if (error) throw error;

                if (data.user && !data.session) {
                    updateStatus('warning', 'Usuario creado. Requiere confirmación de email en Supabase.');
                } else {
                    updateStatus('success', 'Usuario creado exitosamente.');
                    
                    // Limpiar campos
                    document.getElementById('reg-username').value = '';
                    document.getElementById('reg-fullname').value = '';
                    document.getElementById('reg-password').value = '';
                }

            } catch (err) {
                console.error(err);
                let msg = err.message;
                if (msg.includes('Signups not allowed')) msg = 'Registros desactivados en Supabase.';
                if (msg.includes('Database error')) msg = 'Error de base de datos (posible falta de tablas).';
                updateStatus('danger', 'Error al registrar: ' + msg);
            }
        }

        async function showUser(user) {
            document.getElementById('user-section').classList.remove('d-none');
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-id').textContent = 'ID: ' + user.id.substring(0, 8) + '...';

            const roleBadge = document.getElementById('user-role');
            roleBadge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Consultando rol...';
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', user.id)
                    .single();
                
                if (data) {
                    roleBadge.className = 'badge bg-primary text-white mb-3 p-2 w-100';
                    roleBadge.innerHTML = `<i class="fas fa-user-tag me-2"></i>${data.role.toUpperCase()}`;
                } else {
                    roleBadge.className = 'badge bg-secondary text-white mb-3 p-2 w-100';
                    roleBadge.innerHTML = 'Viewer (Por defecto)';
                }
            } catch (e) {
                roleBadge.textContent = 'Error consultando rol';
            }
        }

        async function testRead() {
            const resultDiv = document.getElementById('data-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Leyendo...';
            try {
                const { data, error } = await window.supabaseClient
                    .from('custom_parte_operaciones')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                resultDiv.innerHTML = '<div class="alert alert-success py-1 px-2 mb-0 mt-2"><i class="fas fa-check me-1"></i> Lectura exitosa.</div>';
            } catch (e) {
                resultDiv.innerHTML = `<div class="alert alert-danger py-1 px-2 mb-0 mt-2"><i class="fas fa-times me-1"></i> ${e.message}</div>`;
            }
        }

        async function logout() {
            await window.supabaseClient.auth.signOut();
            location.reload();
        }

        checkSession();
    </script>
</body>
</html>
