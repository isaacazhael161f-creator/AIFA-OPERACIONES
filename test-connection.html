<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIFA Operaciones - Diagn√≥stico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
    <style>
        body {
            background-color: #f0f4f8;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23dbeafe' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        .card-header-custom {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            color: white;
        }
        .avatar-circle {
            width: 40px;
            height: 40px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #495057;
        }
        .logo-icon {
            width: 64px;
            height: 64px;
        }
    </style>
</head>
<body class="bg-light d-flex align-items-center min-vh-100">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6 col-xl-5">
                
                <div class="text-center mb-4">
                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center shadow-sm mb-3 logo-icon">
                        <i class="fas fa-plane-departure fa-2x"></i>
                    </div>
                    <h2 class="fw-bold text-dark">AIFA Operaciones</h2>
                    <p class="text-muted small text-uppercase letter-spacing-2">Diagn√≥stico de Conexi√≥n</p>
                </div>

                <!-- Card Principal -->
                <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
                    <div class="card-header bg-white border-0 pt-4 pb-0 px-4">
                        <div id="status" class="alert alert-light border d-flex align-items-center small mb-0" role="alert">
                            <i class="fas fa-spinner fa-spin me-2 text-primary"></i>
                            <div class="text-muted">Iniciando sistema...</div>
                        </div>
                    </div>

                    <div class="card-body p-4">
                        
                        <!-- Tabs de Navegaci√≥n -->
                        <ul class="nav nav-pills nav-fill mb-4 p-1 bg-light rounded-pill" id="pills-tab" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active rounded-pill small fw-bold" id="pills-login-tab" data-bs-toggle="pill" data-bs-target="#pills-login" type="button" role="tab" aria-controls="pills-login" aria-selected="true">
                                    <i class="fas fa-sign-in-alt me-2"></i>Acceso
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link rounded-pill small fw-bold" id="pills-register-tab" data-bs-toggle="pill" data-bs-target="#pills-register" type="button" role="tab" aria-controls="pills-register" aria-selected="false">
                                    <i class="fas fa-user-plus me-2"></i>Registro
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link rounded-pill small fw-bold" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">
                                    <i class="fas fa-user-edit me-2"></i>Perfil
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link rounded-pill small fw-bold" id="pills-users-tab" data-bs-toggle="pill" data-bs-target="#pills-users" type="button" role="tab" aria-controls="pills-users" aria-selected="false" onclick="loadUsers()">
                                    <i class="fas fa-users-cog me-2"></i>Usuarios
                                </button>
                            </li>
                        </ul>

                        <div class="tab-content" id="pills-tabContent">
                            <!-- Login -->
                            <div class="tab-pane fade show active" id="pills-login" role="tabpanel">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" id="username" placeholder="Usuario">
                                    <label for="username" class="text-muted"><i class="fas fa-user me-2"></i>Usuario</label>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control bg-light border-0" id="password" placeholder="Contrase√±a">
                                    <label for="password" class="text-muted"><i class="fas fa-lock me-2"></i>Contrase√±a</label>
                                </div>
                                <button class="btn btn-primary w-100 py-3 rounded-3 fw-bold shadow-sm" onclick="testLogin()">
                                    <i class="fas fa-paper-plane me-2"></i>INICIAR SESI√ìN
                                </button>
                            </div>

                            <!-- Registro -->
                            <div class="tab-pane fade" id="pills-register" role="tabpanel">
                                
                                <h6 class="text-primary mb-3 small fw-bold text-uppercase border-bottom pb-2">
                                    <i class="fas fa-user-circle me-2"></i>1. Datos de Cuenta
                                </h6>

                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" id="reg-username" placeholder="Usuario">
                                    <label for="reg-username" class="text-muted"><i class="fas fa-user me-2"></i>Usuario (ID)</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control bg-light border-0" id="reg-email" placeholder="Correo electr√≥nico (Opcional)">
                                    <label for="reg-email" class="text-muted"><i class="fas fa-envelope me-2"></i>Correo (Permite recuperaci√≥n)</label>
                                </div>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" id="reg-fullname" placeholder="Nombre Completo">
                                    <label for="reg-fullname" class="text-muted"><i class="fas fa-id-card me-2"></i>Nombre Completo</label>
                                </div>
                                <div class="form-floating mb-4">
                                    <input type="password" class="form-control bg-light border-0" id="reg-password" placeholder="Contrase√±a">
                                    <label for="reg-password" class="text-muted"><i class="fas fa-lock me-2"></i>Contrase√±a</label>
                                </div>

                                <h6 class="text-primary mb-3 small fw-bold text-uppercase border-bottom pb-2 mt-4">
                                    <i class="fas fa-user-shield me-2"></i>2. Configuraci√≥n de Rol
                                </h6>

                                <div class="mb-3">
                                    <label for="reg-role" class="form-label small fw-bold text-muted">Tipo de Usuario</label>
                                    <select class="form-select bg-light border-0" id="reg-role" onchange="toggleRegPermissions()" aria-label="Seleccionar rol de usuario">
                                        <option value="viewer" selected>üëÄ Visualizador (Solo Lectura)</option>
                                        <option value="editor">‚úèÔ∏è Editor (Operaciones)</option>
                                        <option value="control_fauna">ü¶Ö Control Fauna</option>
                                        <option value="servicio_medico">üöë Servicio M√©dico</option>
                                        <option value="admin">üõ†Ô∏è Administrador</option>
                                    </select>
                                </div>

                                <div id="reg-permissions-container" class="mb-4 p-3 bg-white border rounded">
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" id="reg-full-access" checked onchange="toggleRegCheckboxes()">
                                        <label class="form-check-label fw-bold small" for="reg-full-access">
                                            Acceso Total (Ver todas las secciones)
                                        </label>
                                    </div>

                                    <div id="reg-section-checks" class="d-none">
                                        <div class="small text-muted mb-2">Seleccione las secciones visibles:</div>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="operaciones-totales" id="reg-sec-inicio" checked>
                                                    <label class="form-check-label small" for="reg-sec-inicio">Inicio (Dashboard)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="parte-operaciones" id="reg-sec-parte">
                                                    <label class="form-check-label small" for="reg-sec-parte">Parte Operaciones</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="inicio" id="reg-sec-itinerario">
                                                    <label class="form-check-label small" for="reg-sec-itinerario">Itinerario Diario</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="frecuencias-semana" id="reg-sec-frec">
                                                    <label class="form-check-label small" for="reg-sec-frec">Frecuencias</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="itinerario-mensual" id="reg-sec-itin-mensual">
                                                    <label class="form-check-label small" for="reg-sec-itin-mensual">Itinerario Mensual</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="puntualidad-agosto" id="reg-sec-punt">
                                                    <label class="form-check-label small" for="reg-sec-punt">Puntualidad</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="demoras" id="reg-sec-dem">
                                                    <label class="form-check-label small" for="reg-sec-dem">Demoras</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="fauna" id="reg-sec-fauna">
                                                    <label class="form-check-label small" for="reg-sec-fauna">Fauna (GSO)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="medicas" id="reg-sec-med">
                                                    <label class="form-check-label small" for="reg-sec-med">M√©dico</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input reg-section-check" type="checkbox" value="biblioteca" id="reg-sec-bib">
                                                    <label class="form-check-label small" for="reg-sec-bib">Biblioteca y Docs</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <button class="btn btn-success w-100 py-3 rounded-3 fw-bold shadow-sm" onclick="testRegister()">
                                    <i class="fas fa-user-plus me-2"></i>CREAR USUARIO Y PERMISOS
                                </button>
                            </div>

                            <!-- Perfil -->
                            <div class="tab-pane fade" id="pills-profile" role="tabpanel">
                                <div class="alert alert-info small mb-3" id="profile-alert">
                                    <i class="fas fa-info-circle me-1"></i> Inicia sesi√≥n para editar tus datos.
                                </div>
                                <fieldset id="profile-fieldset" disabled>
                                    <div class="form-floating mb-3">
                                        <input type="text" class="form-control bg-light border-0" id="profile-fullname" placeholder="Nombre Completo">
                                        <label for="profile-fullname" class="text-muted"><i class="fas fa-id-card me-2"></i>Nombre Completo</label>
                                    </div>
                                    <button class="btn btn-warning w-100 py-3 rounded-3 fw-bold shadow-sm text-white" onclick="updateProfile()">
                                        <i class="fas fa-save me-2"></i>ACTUALIZAR DATOS
                                    </button>
                                </fieldset>
                            </div>

                            <!-- Usuarios (Generador de Permisos) -->
                            <div class="tab-pane fade" id="pills-users" role="tabpanel">
                                <div class="alert alert-info small mb-3">
                                    <i class="fas fa-tools me-1"></i> Generador de SQL para Usuarios Viewer.
                                </div>
                                
                                <form id="viewer-gen-form" onsubmit="event.preventDefault(); generateViewerSQL();">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold" for="gen-email">Email del Usuario</label>
                                        <input type="email" class="form-control" id="gen-email" placeholder="usuario@ejemplo.com" required>
                                        <div class="form-text small">El script buscar√° este email en auth.users.</div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold" for="gen-role">Rol</label>
                                        <select class="form-select" id="gen-role">
                                            <option value="viewer" selected>Viewer (Solo lectura selectiva)</option>
                                            <option value="editor">Editor</option>
                                            <option value="control_fauna">Control Fauna</option>
                                            <option value="servicio_medico">Servicio M√©dico</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold">Secciones Permitidas (Solo para Viewer)</label>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="operaciones-totales" id="sec-inicio" checked>
                                                    <label class="form-check-label small" for="sec-inicio">Inicio (Dashboard)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="parte-operaciones" id="sec-parte">
                                                    <label class="form-check-label small" for="sec-parte">Parte Operaciones</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="inicio" id="sec-itinerario">
                                                    <label class="form-check-label small" for="sec-itinerario">Itinerario Diario</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="frecuencias-semana" id="sec-frec">
                                                    <label class="form-check-label small" for="sec-frec">Frecuencias</label>
                                                </div>
                                            </div>
                                            <div class="col-6">
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="puntualidad-agosto" id="sec-punt">
                                                    <label class="form-check-label small" for="sec-punt">Puntualidad</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="demoras" id="sec-dem">
                                                    <label class="form-check-label small" for="sec-dem">Demoras</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="fauna" id="sec-fauna">
                                                    <label class="form-check-label small" for="sec-fauna">Fauna (GSO)</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="medicas" id="sec-med">
                                                    <label class="form-check-label small" for="sec-med">M√©dico</label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input section-check" type="checkbox" value="biblioteca" id="sec-bib">
                                                    <label class="form-check-label small" for="sec-bib">Biblioteca</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="d-grid gap-2 mb-3">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fas fa-code me-1"></i> Generar Script SQL
                                        </button>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small fw-bold" for="gen-output">Script SQL Resultante</label>
                                        <textarea class="form-control font-monospace small bg-dark text-white" id="gen-output" rows="8" readonly></textarea>
                                        <div class="form-text small">Copia este c√≥digo y ejec√∫talo en el Editor SQL de Supabase.</div>
                                    </div>
                                    <button type="button" class="btn btn-outline-secondary btn-sm w-100" onclick="navigator.clipboard.writeText(document.getElementById('gen-output').value)">Copiar al Portapapeles</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sesi√≥n Actual (Overlay o Card inferior) -->
                <div id="user-section" class="card shadow-sm border-0 mt-4 d-none rounded-4">
                    <div class="card-body p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="bg-success bg-opacity-10 text-success rounded-circle p-3 me-3">
                                <i class="fas fa-user-shield fa-2x"></i>
                            </div>
                            <div class="overflow-hidden">
                                <h6 class="mb-1 fw-bold text-dark" id="user-email">usuario@aifa.operaciones</h6>
                                <div class="badge bg-light text-secondary border" id="user-id">ID: ...</div>
                            </div>
                        </div>
                        
                        <div class="badge bg-primary bg-opacity-10 text-primary mb-3 p-2 w-100 rounded-3" id="user-role">
                            <i class="fas fa-spinner fa-spin me-1"></i> Verificando rol...
                        </div>

                        <div class="row g-2">
                            <div class="col-6">
                                <button class="btn btn-outline-primary w-100 btn-sm py-2" onclick="testRead()">
                                    <i class="fas fa-database me-1"></i>Test DB
                                </button>
                            </div>
                            <div class="col-6">
                                <button class="btn btn-outline-danger w-100 btn-sm py-2" onclick="logout()">
                                    <i class="fas fa-sign-out-alt me-1"></i>Salir
                                </button>
                            </div>
                        </div>
                        <div id="data-result" class="mt-3 small text-center"></div>
                    </div>
                </div>

                <div class="text-center mt-4 text-muted small">
                    &copy; 2025 AIFA Operaciones &bull; v1.0.0
                </div>

            </div>
        </div>
    </div>

    <script>
        async function checkSession() {
            if (!window.supabaseClient) {
                updateStatus('danger', 'Error: window.supabaseClient no est√° definido.');
                return;
            }
            updateStatus('success', 'Cliente Supabase listo. Conectado.');

            const { data: { session } } = await window.supabaseClient.auth.getSession();
            if (session) {
                showUser(session.user);
            }
        }

        function updateStatus(type, msg) {
            const el = document.getElementById('status');
            el.className = `alert alert-${type} d-flex align-items-center`;
            let icon = 'info-circle';
            if (type === 'success') icon = 'check-circle';
            if (type === 'danger') icon = 'exclamation-triangle';
            if (type === 'warning') icon = 'exclamation-circle';
            
            el.innerHTML = `<i class="fas fa-${icon} me-2"></i><div>${msg}</div>`;
        }

        async function testLogin() {
            let username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            updateStatus('info', 'Autenticando...');

            try {
                if (!username.includes('@')) {
                    const normalized = username.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '.');
                    username = `${normalized}@aifa.operaciones`;
                }

                const { data, error } = await window.supabaseClient.auth.signInWithPassword({
                    email: username,
                    password
                });

                if (error) throw error;
                
                updateStatus('success', '¬°Bienvenido a bordo! Login correcto.');
                showUser(data.user);

            } catch (err) {
                updateStatus('danger', 'Error de autenticaci√≥n: ' + err.message);
            }
        }

        function toggleRegPermissions() {
            const role = document.getElementById('reg-role').value;
            const container = document.getElementById('reg-permissions-container');
            if (role === 'viewer') {
                container.classList.remove('d-none');
            } else {
                container.classList.add('d-none');
            }
        }

        function toggleRegCheckboxes() {
            const fullAccess = document.getElementById('reg-full-access').checked;
            const checkboxesDiv = document.getElementById('reg-section-checks');
            if (fullAccess) {
                checkboxesDiv.classList.add('d-none');
            } else {
                checkboxesDiv.classList.remove('d-none');
            }
        }

        async function testRegister() {
            let username = document.getElementById('reg-username').value;
            const emailInput = document.getElementById('reg-email').value;
            const fullName = document.getElementById('reg-fullname').value;
            const password = document.getElementById('reg-password').value;
            
            // New Fields
            const role = document.getElementById('reg-role').value;
            const isViewer = role === 'viewer';
            const isFullAccess = document.getElementById('reg-full-access').checked;
            
            let permissions = {};
            if (isViewer) {
                if (isFullAccess) {
                    // Empty allowed_sections implies no restrictions if logic handles it that way, 
                    // BUT current app logic might treat empty as "nothing allowed".
                    // Let's explicitly list ALL known sections to be safe, or use a special "all" token if supported.
                    // Based on script.js, checking includes(). 
                    // Better approach: Populate with ALL known sections if Full Access.
                    permissions.allowed_sections = [
                        'operaciones-totales', 'parte-operaciones', 'inicio', 'frecuencias-semana', 
                        'itinerario-mensual', 'puntualidad-agosto', 'demoras', 'fauna', 'medicas', 
                        'biblioteca', 'comparativa', 'manifiestos', 'data-management', 'historia'
                    ];
                } else {
                    const checks = document.querySelectorAll('.reg-section-check:checked');
                    permissions.allowed_sections = Array.from(checks).map(c => c.value);
                }
            } else {
                // Non-viewers usually have full access by role definition, but we can set empty
                permissions.allowed_sections = []; 
            }

            if (!username || !password) {
                alert('Usuario y contrase√±a requeridos');
                return;
            }

            updateStatus('info', 'Registrando nuevo tripulante y configurando permisos...');

            try {
                let authEmail = username;
                if (!authEmail.includes('@')) {
                    const normalized = username.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, '.');
                    authEmail = `${normalized}@aifa.operaciones`;
                }

                // 1. Create User via SignUp
                // We store role/permissions in metadata so a Trigger can pick it up
                const { data, error } = await window.supabaseClient.auth.signUp({
                    email: authEmail,
                    password: password,
                    options: { 
                        data: { 
                            full_name: fullName,
                            username: username,
                            contact_email: emailInput || '',
                            // CRITICAL: Storing role/perms in metadata
                            role: role, 
                            permissions: permissions 
                        } 
                    }
                });

                if (error) throw error;

                // 2. Attempt to write to user_roles directly (Best Effort)
                if (data.user) {
                    const userId = data.user.id;
                    try {
                        const { error: roleErr } = await window.supabaseClient
                            .from('user_roles')
                            .insert({
                                user_id: userId,
                                role: role,
                                permissions: permissions
                            });
                        
                        if (roleErr) {
                            console.warn('Direct role insert failed (expected if non-admin):', roleErr);
                            // Do not throw, we rely on metadata + trigger (if set up) or manual SQL
                        } else {
                            console.log('Direct role insert successful!');
                        }
                    } catch (ignore) {}
                }

                if (data.user && !data.session) {
                    updateStatus('warning', `Usuario creado (ID: ${data.user.id}). Requiere confirmaci√≥n/Trigger para permisos.`);
                } else {
                    updateStatus('success', `Usuario ${username} creado con rol ${role.toUpperCase()}.`);
                    
                    // Clear fields
                    document.getElementById('reg-username').value = '';
                    document.getElementById('reg-fullname').value = '';
                    document.getElementById('reg-password').value = '';
                    // Reset defaults
                    document.getElementById('reg-role').value = 'viewer';
                    toggleRegPermissions();
                }

            } catch (err) {
                console.error(err);
                let msg = err.message;
                updateStatus('danger', 'Error al registrar: ' + msg);
            }
        }

        async function showUser(user) {
            document.getElementById('user-section').classList.remove('d-none');
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-id').textContent = 'ID: ' + user.id.substring(0, 8) + '...';

            // Enable Profile Tab
            document.getElementById('profile-fieldset').disabled = false;
            document.getElementById('profile-alert').classList.add('d-none');
            
            // Populate Profile Data
            const meta = user.user_metadata || {};
            document.getElementById('profile-fullname').value = meta.full_name || '';

            const roleBadge = document.getElementById('user-role');
            roleBadge.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Consultando rol...';
            
            try {
                const { data, error } = await window.supabaseClient
                    .from('user_roles')
                    .select('role')
                    .eq('user_id', user.id)
                    .single();
                
                if (data) {
                    roleBadge.className = 'badge bg-primary text-white mb-3 p-2 w-100';
                    roleBadge.innerHTML = `<i class="fas fa-user-tag me-2"></i>${data.role.toUpperCase()}`;
                } else {
                    roleBadge.className = 'badge bg-secondary text-white mb-3 p-2 w-100';
                    roleBadge.innerHTML = 'Viewer (Por defecto)';
                }
            } catch (e) {
                roleBadge.textContent = 'Error consultando rol';
            }
        }

        async function updateProfile() {
            const fullName = document.getElementById('profile-fullname').value;
            if(!fullName) {
                alert("El nombre completo no puede estar vac√≠o");
                return;
            }

            updateStatus('info', 'Actualizando perfil...');

            try {
                const { data, error } = await window.supabaseClient.auth.updateUser({
                    data: { full_name: fullName }
                });

                if (error) throw error;
                
                updateStatus('success', 'Perfil actualizado correctamente.');
                
                // Update local display if needed (though showUser relies on session object which might need refresh)
                // data.user contains the updated user object
                if(data.user) {
                    showUser(data.user);
                }

            } catch (err) {
                updateStatus('danger', 'Error al actualizar perfil: ' + err.message);
            }
        }

        async function testRead() {
            const resultDiv = document.getElementById('data-result');
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Leyendo...';
            try {
                const { data, error } = await window.supabaseClient
                    .from('custom_parte_operaciones')
                    .select('count')
                    .limit(1);
                
                if (error) throw error;
                resultDiv.innerHTML = '<div class="alert alert-success py-1 px-2 mb-0 mt-2"><i class="fas fa-check me-1"></i> Lectura exitosa.</div>';
            } catch (e) {
                resultDiv.innerHTML = `<div class="alert alert-danger py-1 px-2 mb-0 mt-2"><i class="fas fa-times me-1"></i> ${e.message}</div>`;
            }
        }

        async function logout() {
            await window.supabaseClient.auth.signOut();
            location.reload();
        }

        // --- Generator Logic ---
        function generateViewerSQL() {
            const email = document.getElementById('gen-email').value;
            if (!email) {
                alert('Por favor ingrese un email.');
                return;
            }
            const role = document.getElementById('gen-role').value;
            
            // Get checked sections
            const checks = document.querySelectorAll('.section-check:checked');
            const sections = Array.from(checks).map(c => c.value);
            
            // Construct JSON
            const permissions = { allowed_sections: sections };
            const jsonPermissions = JSON.stringify(permissions);

            // Construct SQL Block
            const sql = `
-- 1. Asegurar que la columna permissions existe (Ejecutar esto primero si falla)
ALTER TABLE public.user_roles 
ADD COLUMN IF NOT EXISTS permissions JSONB DEFAULT '{}'::jsonb;

DO $$
DECLARE
    v_target_email TEXT := '${email.trim()}';
    v_user_id UUID;
    v_role TEXT := '${role}';
    v_permissions JSONB := '${jsonPermissions}'::jsonb;
BEGIN
    -- 1. Buscar ID del usuario por email en auth.users
    SELECT id INTO v_user_id FROM auth.users WHERE email = v_target_email;

    IF v_user_id IS NULL THEN
        RAISE EXCEPTION 'Usuario con email % no encontrado. Aseg√∫rese de haberlo creado en Authentication primero.', v_target_email;
    END IF;

    -- 2. Insertar o Actualizar Rol y Permisos en public.user_roles
    INSERT INTO public.user_roles (user_id, role, permissions)
    VALUES (v_user_id, v_role, v_permissions)
    ON CONFLICT (user_id) 
    DO UPDATE SET 
        role = EXCLUDED.role,
        permissions = EXCLUDED.permissions;

    RAISE NOTICE 'Permisos actualizados para usuario % (Rol: %, Secciones: count=%)', v_target_email, v_role, jsonb_array_length(v_permissions->'allowed_sections');
END $$;
`;
            document.getElementById('gen-output').value = sql.trim();
        }

        async function loadUsers() { console.log('Legacy loadUsers stub'); }
        async function assignRole(userId) { console.log('Legacy assignRole stub'); }

        checkSession();
    </script>
</body>
</html>
